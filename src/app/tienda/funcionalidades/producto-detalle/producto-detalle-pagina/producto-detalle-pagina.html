<!-- ─── Contenedor principal ─── -->
<div class="tienda-producto-detalle">
  @if (estaCargando()) {
  <p class="tienda-producto-detalle__mensaje">Cargando producto...</p>
  } @else if (errorCarga()) {
  <p class="tienda-producto-detalle__mensaje">{{ errorCarga() }}</p>
  } @else if (producto(); as p) {

  <!-- ─── Banner de fondo ─── -->
  <div class="tienda-producto-detalle__fondo">
    <img [src]="obtenerImagenBanner(p)" [alt]="p.titulo" class="tienda-producto-detalle__imagen-banner" />
  </div>

  <div class="tienda-producto-detalle__contenido">
    <!-- ─── Header: imagen, título, fila servidores, categorías, nota login ─── -->
    <div class="tienda-producto-detalle__header">
      <img [src]="obtenerImagenJuego(p)" [alt]="p.titulo" class="tienda-producto-detalle__imagen-juego" />
      <div class="tienda-producto-detalle__contenido-header">
        <div class="tienda-producto-detalle__titulo-fila">
          <h3 class="tienda-producto-detalle__titulo">{{ p.titulo }}</h3>
        </div>
        <!-- Fila 1: icono + "Disponible en todos los servidores" (cuando servidorDinamico no es true) -->
        @if (p.servidorDinamico !== true) {
        <p class="tienda-producto-detalle__info">
          <img src="/iconos/ico-server.svg" alt="Servidor" class="icono-boton icono-color-blanco" />
          <span>Disponible en todos los servidores</span>
        </p>
        }
        <!-- Fila 2: icono + categorías -->
        <!-- Fila 3: categorías; aviso para "Comprar ahora" (requiere iniciar sesión) -->
        @if ((p.categorias ?? []).length || requiereLogin()) {
        <p class="tienda-producto-detalle__info" [class.tienda-producto-detalle__aviso-login]="requiereLogin()">
          <img src="/iconos/ico-informacion.svg" alt="Info" class="icono-boton icono-color-blanco" />
          @if ((p.categorias ?? []).length) {
          <span>{{ (p.categorias ?? []).join(', ') }}</span>
          }
          @if (requiereLogin()) {
          <span>{{ (p.categorias ?? []).length ? ' - ' : '' }}Para <strong>Comprar ahora</strong> debes
            <a routerLink="/" [queryParams]="{ login: 'checkout' }">iniciar sesión o registrarte</a>. Puedes agregar al carrito sin cuenta.</span>
          }
        </p>
        }

        <span class="tienda-producto-detalle__badge-tipo"
          [class.tienda-producto-detalle__badge-tipo--manual]="tipoEntrega(p) === 'manual'"
          [class.tienda-producto-detalle__badge-tipo--automatico]="tipoEntrega(p) === 'automatico'">
          {{ tipoEntrega(p) === 'manual' ? 'MANUAL' : 'AUTOMÁTICO' }}
        </span>
      </div>
    </div>

    <!-- ─── Contenido principal: dos columnas ─── -->
    <div class="tienda-producto-detalle__principal">

      <!-- ─── Columna izquierda: variantes y acordeones ─── -->
      <div class="tienda-producto-detalle__izquierda">
        <div class="tienda-producto-detalle__variantes">
          <!-- Mensaje cuando el producto no tiene stock en ningún precio -->
          @if (productoTodoAgotado()) {
          <div class="tienda-producto-detalle__alerta-agotado" role="alert">
            <div class="tienda-producto-detalle__alerta-cuerpo">
              <span class="tienda-producto-detalle__alerta-icono">
                <img src="/iconos/ico-informacion.svg" alt="" width="20" height="20" />
              </span>
              <div class="tienda-producto-detalle__alerta-textos">
                <p class="tienda-producto-detalle__alerta-texto">Este producto no está disponible por el momento</p>
                <p class="tienda-producto-detalle__alerta-subtexto">Estamos reponiendo stock. Te invitamos a volver pronto
                  o contactar a soporte si quieres saber cuándo podría estar disponible de nuevo.</p>
              </div>
            </div>
          </div>
          }
          <!-- Lista de variantes (desktop) -->
          <div class="tienda-producto-detalle__variantes-lista tienda-producto-detalle__variantes-lista--desktop">
            @for (variante of variantes(); track variante.id) {
            <button type="button" class="tienda-producto-detalle__variante"
              [class.tienda-producto-detalle__variante--agotada]="!variante.disponible" [disabled]="!variante.disponible"
              (click)="seleccionarVariante(variante.id)">
              <input type="radio" name="variante" class="global-radio__input" [value]="variante.id"
                [checked]="varianteSeleccionada() === variante.id && variante.disponible"
                [disabled]="!variante.disponible" (change)="variante.disponible && seleccionarVariante(variante.id)" />
              <span class="tienda-producto-detalle__variante-nombre">{{ variante.nombre }}</span>
              <div class="tienda-producto-detalle__variante-contenido">
                @if (variante.disponible) {
                <span class="tienda-producto-detalle__variante-precio">${{ variante.precio | number:'1.2-2' }}</span>
                } @else {
                <span class="tienda-producto-detalle__variante-agotado">Agotado</span>
                }
              </div>
            </button>
            }
          </div>
          @if (!productoTodoAgotado()) {
          <button type="button" class="tienda-producto-detalle__boton-seleccionar-paquete"
            (click)="abrirBottomSheetVariantes()">
            SELECCIONAR PAQUETE
          </button>
          }

          <!-- Acordeones: solo se muestran si tienen contenido -->
          <div class="tienda-producto-detalle__dropdowns">
            @if (p.descripcion?.trim()) {
            <div class="tienda-producto-detalle__dropdown">
              <button type="button" class="tienda-producto-detalle__dropdown-boton" (click)="alternarDescripcion()">
                <span>Descripción</span>
                <img src="/iconos/ico-flecha-abajo-opciones.svg" alt="Flecha"
                  class="tienda-producto-detalle__dropdown-flecha"
                  [class.tienda-producto-detalle__dropdown-flecha--abierta]="descripcionAbierta()" />
              </button>
              @if (descripcionAbierta()) {
              <div class="tienda-producto-detalle__dropdown-contenido">
                <p class="tienda-producto-detalle__dropdown-texto" [innerHTML]="p.descripcion ?? ''"></p>
              </div>
              }
            </div>
            }
            @if (p.comoCanjear?.trim()) {
            <div class="tienda-producto-detalle__dropdown">
              <button type="button" class="tienda-producto-detalle__dropdown-boton" (click)="alternarInstrucciones()">
                <span>Cómo canjear</span>
                <img src="/iconos/ico-flecha-abajo-opciones.svg" alt="Flecha"
                  class="tienda-producto-detalle__dropdown-flecha"
                  [class.tienda-producto-detalle__dropdown-flecha--abierta]="instruccionesAbierta()" />
              </button>
              @if (instruccionesAbierta()) {
              <div class="tienda-producto-detalle__dropdown-contenido">
                <p class="tienda-producto-detalle__dropdown-texto" [innerHTML]="p.comoCanjear ?? ''"></p>
              </div>
              }
            </div>
            }
            @if (p.terminosCondiciones?.trim()) {
            <div class="tienda-producto-detalle__dropdown">
              <button type="button" class="tienda-producto-detalle__dropdown-boton" (click)="alternarTerminos()">
                <span>Términos y Condiciones</span>
                <img src="/iconos/ico-flecha-abajo-opciones.svg" alt="Flecha"
                  class="tienda-producto-detalle__dropdown-flecha"
                  [class.tienda-producto-detalle__dropdown-flecha--abierta]="terminosAbierta()" />
              </button>
              @if (terminosAbierta()) {
              <div class="tienda-producto-detalle__dropdown-contenido">
                <p class="tienda-producto-detalle__dropdown-texto" [innerHTML]="p.terminosCondiciones ?? ''"></p>
              </div>
              }
            </div>
            }
          </div>
        </div>
      </div>

      <!-- ─── Columna derecha: formulario, pago, resumen, botones ─── -->
      <div class="tienda-producto-detalle__derecha">

        <!-- Formulario: solo si servidorDinamico true (muestra servidor) o hay camposDinamicos -->
        @if (p.servidorDinamico === true || p.camposDinamicos.length > 0) {
        <div class="tienda-producto-detalle__seccion" id="seccion-ingresa-tus-datos">
          <h4 class="tienda-producto-detalle__seccion-titulo">Ingresa tus datos</h4>
          <div class="tienda-producto-detalle__formulario">
            @if (p.servidorDinamico === true) {
            <div class="global-formulario-campo tienda-producto-detalle__campo-servidor">
              <label class="global-formulario-campo__etiqueta">Servidor</label>
              <div class="global-formulario-campo__contenedor tienda-producto-detalle__dropdown-servidor">
                <select class="tienda-producto-detalle__select-servidor" [value]="servidor()"
                  (change)="servidor.set($any($event.target).value)">
                  <option value="">Selecciona un servidor</option>
                  @for (opcion of opcionesServidor(); track opcion) {
                  <option [value]="opcion">{{ opcion }}</option>
                  }
                </select>
                <img src="/iconos/ico-flecha-abajo-opciones.svg" alt="" class="tienda-producto-detalle__select-flecha"
                  aria-hidden="true">
              </div>
            </div>
            }
            @for (campo of camposDinamicosVisibles(); track campo.handle) {
            <div class="global-formulario-campo">
              <label class="global-formulario-campo__etiqueta">{{ campo.etiqueta }}{{ campo.requerido ? ' *' : ''
                }}</label>
              <div class="global-formulario-campo__contenedor">
                <input type="text" class="global-formulario-campo__input" [placeholder]="campo.etiqueta"
                  [value]="(valoresCamposDinamicos()[campo.handle] || '')"
                  (input)="actualizarCampoDinamico(campo.handle, $any($event.target).value)">
              </div>
            </div>
            }
          </div>
        </div>
        }

        <!-- Resumen del pedido -->
        <div class="tienda-producto-detalle__seccion" id="seccion-resumen-pedido">
          <h4 class="tienda-producto-detalle__seccion-titulo">Resumen del pedido</h4>
          <div class="tienda-producto-detalle__resumen">
            @if (varianteActual(); as va) {
            <div class="tienda-producto-detalle__resumen-item">
              <span class="tienda-producto-detalle__resumen-label">Variante:</span>
              <span class="tienda-producto-detalle__resumen-valor">{{ va.nombre }}</span>
            </div>
            @if (va.inventario != null) {
            <div class="tienda-producto-detalle__resumen-item">
              <span class="tienda-producto-detalle__resumen-label">Disponibles:</span>
              <span class="tienda-producto-detalle__resumen-valor">{{ va.inventario }} unidades</span>
            </div>
            }
            <div class="tienda-producto-detalle__resumen-item">
              <span class="tienda-producto-detalle__resumen-label">Cantidad:</span>
              <div class="tienda-producto-detalle__cantidad-controls">
                <button type="button" class="tienda-producto-detalle__cantidad-boton"
                  (click)="decrementarCantidad()">-</button>
                <span class="tienda-producto-detalle__cantidad-valor">{{ cantidad() }}</span>
                <button type="button" class="tienda-producto-detalle__cantidad-boton"
                  [disabled]="cantidad() >= cantidadMaxima()" (click)="incrementarCantidad()">+</button>
              </div>
            </div>
            <div class="tienda-producto-detalle__resumen-item tienda-producto-detalle__resumen-item--total">
              <span class="tienda-producto-detalle__resumen-label">Total:</span>
              <span class="tienda-producto-detalle__resumen-precio">${{ precioTotal() | number:'1.2-2' }}</span>
            </div>
            } @else if (productoTodoAgotado()) {
            <p class="tienda-producto-detalle__resumen-sin-stock">No hay variantes disponibles para seleccionar.</p>
            }
          </div>
        </div>

        <!-- Aviso cuando ya tiene el máximo en el carrito (stock cubierto) -->
        @if (varianteActual() && cantidadMaxima() === 0 && (varianteActual()?.inventario ?? 0) > 0) {
        <p class="tienda-producto-detalle__resumen-sin-stock">Ya tienes el máximo disponible en el carrito ({{ varianteActual()!.inventario }} unidades). No puedes agregar más hasta que bajes la cantidad en el carrito.</p>
        }
        <!-- Botones de acción: agregar al carrito (sin login, con campos); comprar ahora (con login y campos) -->
        <div class="tienda-producto-detalle__acciones">
          <button type="button" class="boton-primario tienda-producto-detalle__boton"
            [disabled]="productoTodoAgotado() || cantidadMaxima() === 0 || cantidad() < 1" (click)="agregarAlCarrito()">Agregar al carrito</button>
          <button type="button" class="boton-primario tienda-producto-detalle__boton"
            [disabled]="!puedeComprarAhora() || productoTodoAgotado() || cantidadMaxima() === 0 || cantidad() < 1" (click)="comprarAhora()">Comprar ahora</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ─── Bottom sheet móvil: selección de variante ─── -->
  @if (bottomSheetVariantesAbierto()) {
  <div class="tienda-producto-detalle__bottom-sheet-overlay" (click)="cerrarBottomSheetVariantes()" role="button"
    tabindex="-1" aria-label="Cerrar selección de paquete"></div>
  <div class="tienda-producto-detalle__bottom-sheet-panel" role="dialog" tabindex="0"
    (keydown.escape)="cerrarBottomSheetVariantes()" aria-label="Seleccionar paquete o variante">
    <div class="tienda-producto-detalle__bottom-sheet-cabecera">
      <h4 class="tienda-producto-detalle__bottom-sheet-titulo">Seleccionar paquete</h4>
      <button type="button" class="tienda-producto-detalle__bottom-sheet-cerrar" (click)="cerrarBottomSheetVariantes()"
        aria-label="Cerrar">
        <img src="/iconos/ico-cerrar.svg" alt="" class="icono-boton icono-color-secundario" />
      </button>
    </div>
    <div class="tienda-producto-detalle__bottom-sheet-lista">
      @for (variante of variantes(); track variante.id) {
      <button type="button" class="tienda-producto-detalle__variante tienda-producto-detalle__variante--sheet"
        [class.tienda-producto-detalle__variante--agotada]="!variante.disponible" [disabled]="!variante.disponible"
        (click)="variante.disponible && seleccionarVariante(variante.id)">
        <input type="radio" name="variante-sheet" class="global-radio__input" [value]="variante.id"
          [checked]="varianteSeleccionada() === variante.id && variante.disponible" [disabled]="!variante.disponible"
          (change)="variante.disponible && seleccionarVariante(variante.id)" />
        <span class="tienda-producto-detalle__variante-nombre">{{ variante.nombre }}</span>
        <div class="tienda-producto-detalle__variante-contenido">
          @if (variante.disponible) {
          <span class="tienda-producto-detalle__variante-precio">${{ variante.precio | number:'1.2-2' }}</span>
          } @else {
          <span class="tienda-producto-detalle__variante-agotado">Agotado</span>
          }
        </div>
      </button>
      }
    </div>
    <div class="tienda-producto-detalle__bottom-sheet-acciones">
      <button type="button" class="boton-primario tienda-producto-detalle__bottom-sheet-confirmar"
        (click)="confirmarPaquete()">
        Confirmar paquete
      </button>
    </div>
  </div>
  }
  }
</div>