<!-- Filtro por estado (solo los que existen en los pedidos) -->
<div class="perfil-pedidos-filtros-estado">
  @for (opcion of estadosOpciones(); track opcion.valor ?? 'todos') {
  <button type="button" class="perfil-pedidos-switch__btn"
    [class.perfil-pedidos-switch__btn--activo]="estadoFiltro() === opcion.valor"
    (click)="filtrarPorEstado(opcion.valor)">{{ opcion.nombre }}</button>
  }
</div>

<!-- Filtros fecha y nombre -->
<div class="perfil-pedidos-filtros">
  <div class="perfil-pedidos-filtros__grupo perfil-pedidos-filtros__grupo--nombre">
    <label class="perfil-pedidos-filtros__label">Buscar</label>
    <input type="text" class="perfil-pedidos-filtros__input" placeholder="Número de pedido o producto"
      [value]="filtroNombreProducto()" (input)="filtroNombreProducto.set($any($event.target).value)">
  </div>
  <div class="perfil-pedidos-filtros__grupo">
    <label class="perfil-pedidos-filtros__label">Desde</label>
    <input type="date" class="perfil-pedidos-filtros__input" [value]="filtroFechaDesde()"
      (input)="filtroFechaDesde.set($any($event.target).value)">
  </div>
  <div class="perfil-pedidos-filtros__grupo">
    <label class="perfil-pedidos-filtros__label">Hasta</label>
    <input type="date" class="perfil-pedidos-filtros__input" [value]="filtroFechaHasta()"
      (input)="filtroFechaHasta.set($any($event.target).value)">
  </div>
</div>

<!-- Lista de pedidos (paginada: 4 por página) -->
<div class="perfil-pedidos-apartado">
  @if (cargando()) {
  <p class="perfil-pedidos-cargando">Cargando pedidos...</p>
  } @else if (pedidosFiltrados().length === 0) {
  <div class="perfil-pedidos-vacio">
    <img src="/iconos/ico-orden.svg" alt="Sin pedidos" class="perfil-pedidos-vacio__icono">
    <p class="perfil-pedidos-vacio__texto">No hay pedidos o no coinciden con los filtros</p>
    <button type="button" class="boton-primario perfil-billetera__boton" (click)="refrescar.emit()">Actualizar</button>
  </div>
  } @else {
  <div class="perfil-pedidos">
    @for (pedido of pedidosEnPagina(); track pedido.id_pedido) {
    <div class="perfil-pedido-card">
      <div class="perfil-pedido-card__header">
        <div class="perfil-pedido-card__header-info">
          <p class="perfil-pedido-card__fecha">{{ pedido.fecha | date:'d MMM yyyy' }}</p>
          <span class="perfil-pedido-card__badge perfil-pedido-card__badge--{{ pedido.estado }}">{{ pedido.estado }}</span>
        </div>
        <button class="boton-primario perfil-billetera__boton" (click)="reordenar(pedido)" type="button">Reordenar</button>
      </div>
      <p class="perfil-pedido-card__numero">Pedido {{ pedido.numero_pedido }}</p>
      <div class="perfil-pedido-card__productos">
        @for (detalle of pedido.detalles ?? []; track detalle.id_detalle; let index = $index) {
        @if (index < limiteProductosVisibles || mostrarTodosProductos(pedido.id_pedido)) {
        <div class="perfil-pedido-card__producto">
          @if (detalle.imagenes?.square || detalle.imagenUrl) {
          <img [src]="detalle.imagenes?.square ?? detalle.imagenUrl" alt="" class="perfil-pedido-card__producto-imagen" />
          }
          <div class="perfil-pedido-card__producto-info">
            <div class="perfil-pedido-card__producto-titulo">
              <p class="perfil-pedido-card__producto-nombre">{{ detalle.nombreProducto ?? detalle.nombrePrecio ?? 'Ítem' }}</p>
              @if (detalle.estado_entrega) {
              <span class="perfil-pedido-card__detalle-badge perfil-pedido-card__detalle-badge--{{ detalle.estado_entrega }}">{{ detalle.estado_entrega }}</span>
              }
            </div>
            @if (detalle.nombreProducto && detalle.nombrePrecio) {
            <p class="perfil-pedido-card__producto-precio-nombre">{{ detalle.nombrePrecio }}</p>
            }
            <p class="perfil-pedido-card__producto-cantidad">Cantidad: {{ detalle.cantidad }}</p>
            <div class="perfil-pedido-card__producto-montos">
              @if (detalle.precio_unitario != null) {
              <span class="perfil-pedido-card__producto-unitario">${{ detalle.precio_unitario }} USD × {{ detalle.cantidad }}</span>
              }
              <span class="perfil-pedido-card__producto-subtotal">${{ detalle.subtotal }} USD</span>
            </div>
            @if (detalle.codigo) {
            <div class="perfil-pedido-card__codigo-caja">
              <div class="perfil-pedido-card__codigo-caja-inner">
                <p class="perfil-pedido-card__codigo-titulo">Código</p>
                <p class="perfil-pedido-card__codigo-valor">{{ detalle.codigo.codigo }}</p>
              </div>
              <button type="button" class="perfil-pedido-card__codigo-copiar" (click)="copiarCodigo(detalle.codigo.codigo)"
                title="Copiar código" aria-label="Copiar código">
                <img src="/iconos/ico-copiar.svg" alt="" />
              </button>
            </div>
            }
            @if (detalle.valores_campos_legibles && detalle.valores_campos_legibles.length > 0) {
            <div class="perfil-pedido-card__valores-dinamicos-caja">
              <p class="perfil-pedido-card__valores-dinamicos-titulo">Datos que nos proporcionaste</p>
              <ul class="perfil-pedido-card__valores-dinamicos">
                @for (campo of detalle.valores_campos_legibles; track campo.etiqueta) {
                <li class="perfil-pedido-card__valores-dinamicos-item">
                  <span class="perfil-pedido-card__valores-dinamicos-etiqueta">{{ campo.etiqueta }}:</span>
                  <span class="perfil-pedido-card__valores-dinamicos-valor">{{ campo.valor }}</span>
                </li>
                }
              </ul>
            </div>
            }
          </div>
        </div>
        }
        }
        @if ((pedido.detalles?.length ?? 0) > limiteProductosVisibles && !mostrarTodosProductos(pedido.id_pedido)) {
        <button class="perfil-pedido-card__producto-mas" (click)="mostrarMasProductos(pedido.id_pedido)" type="button">
          <span>+{{ (pedido.detalles?.length ?? 0) - limiteProductosVisibles }} más</span>
        </button>
        }
        @if (pedidoTieneCodigos(pedido)) {
        <button type="button" class="perfil-pedido-card__copiar-todos" (click)="copiarTodosCodigos(pedido)">
          <img src="/iconos/ico-copiar.svg" alt="" />
          <span>Copiar todos los códigos</span>
        </button>
        }
      </div>
      <div class="perfil-pedido-card__footer">
        <div class="perfil-pedido-card__resumen">
          <div class="perfil-pedido-card__resumen-item">
            <span class="perfil-pedido-card__resumen-label">Productos:</span>
            <span class="perfil-pedido-card__resumen-valor">{{ cantidadItems(pedido) }}</span>
          </div>
          <div class="perfil-pedido-card__resumen-item perfil-pedido-card__resumen-item--total">
            <span class="perfil-pedido-card__resumen-label">Total:</span>
            <span class="perfil-pedido-card__total-monto">${{ pedido.total }} USD</span>
          </div>
        </div>
      </div>
    </div>
    }
  </div>
  @if (totalPaginas() > 1) {
  <nav class="perfil-pedidos-paginacion" aria-label="Paginación de pedidos">
    <button type="button" class="perfil-pedidos-paginacion__btn"
      [disabled]="paginaActual() <= 1"
      (click)="irPagina(paginaActual() - 1)">Anterior</button>
    <span class="perfil-pedidos-paginacion__info">Página {{ paginaActual() }} de {{ totalPaginas() }}</span>
    <button type="button" class="perfil-pedidos-paginacion__btn"
      [disabled]="paginaActual() >= totalPaginas()"
      (click)="irPagina(paginaActual() + 1)">Siguiente</button>
  </nav>
  }
  }
</div>
