<!-- Switch: Recarga directa o Gift Cards -->
<div class="perfil-pedidos-switch">
  <button type="button" class="perfil-pedidos-switch__btn"
    [class.perfil-pedidos-switch__btn--activo]="tipoPedidoVista() === 'recarga_directa'"
    (click)="tipoPedidoVista.set('recarga_directa')">Recarga directa</button>
  <button type="button" class="perfil-pedidos-switch__btn"
    [class.perfil-pedidos-switch__btn--activo]="tipoPedidoVista() === 'gift_cards'"
    (click)="tipoPedidoVista.set('gift_cards')">Gift Cards</button>
</div>

<!-- Filtros -->
<div class="perfil-pedidos-filtros">
  <div class="perfil-pedidos-filtros__grupo perfil-pedidos-filtros__grupo--nombre">
    <label class="perfil-pedidos-filtros__label">Nombre producto</label>
    <input type="text" class="perfil-pedidos-filtros__input" placeholder="Buscar por nombre"
      [value]="filtroNombreProducto()" (input)="filtroNombreProducto.set($any($event.target).value)">
  </div>
  <div class="perfil-pedidos-filtros__grupo">
    <label class="perfil-pedidos-filtros__label">Desde</label>
    <input type="date" class="perfil-pedidos-filtros__input" [value]="filtroFechaDesde()"
      (input)="filtroFechaDesde.set($any($event.target).value)">
  </div>
  <div class="perfil-pedidos-filtros__grupo">
    <label class="perfil-pedidos-filtros__label">Hasta</label>
    <input type="date" class="perfil-pedidos-filtros__input" [value]="filtroFechaHasta()"
      (input)="filtroFechaHasta.set($any($event.target).value)">
  </div>
</div>

<!-- Pedidos recarga directa -->
@if (tipoPedidoVista() === 'recarga_directa') {
<div class="perfil-pedidos-apartado">
  <h3 class="perfil-pedidos-apartado__titulo">Pedidos automáticos / Compra directa</h3>
  <div class="perfil-pedidos">
    @for (pedido of pedidosAutomaticosFiltrados(); track pedido.id) {
    <div class="perfil-pedido-card">
      <div class="perfil-pedido-card__header">
        <div class="perfil-pedido-card__header-info">
          <p class="perfil-pedido-card__fecha">{{ pedido.fecha_compra | date:'d MMM yyyy, h:mm a' }}</p>
        </div>
        <button class="boton-primario perfil-billetera__boton" (click)="reordenar(pedido)" type="button">Reordenar</button>
        <span class="perfil-pedido-card__badge perfil-pedido-card__badge--{{pedido.estado}}">{{ pedido.estado }}</span>
      </div>
      <div class="perfil-pedido-card__productos">
        @for (prod of pedido.productos; track prod.id; let index = $index) {
        @if (index < limiteProductosVisibles || mostrarTodosProductos(pedido.id)) {
        <div class="perfil-pedido-card__producto">
          <img [src]="prod.imagen || '/imagenes/producto-default.png'" [alt]="prod.nombre"
            class="perfil-pedido-card__producto-imagen">
          <div class="perfil-pedido-card__producto-info">
            <p class="perfil-pedido-card__producto-nombre">{{ prod.nombre }}</p>
            <p class="perfil-pedido-card__producto-cantidad">Cantidad: {{ prod.cantidad }}</p>
          </div>
        </div>
        }
        }
        @if (pedido.productos.length > limiteProductosVisibles && !mostrarTodosProductos(pedido.id)) {
        <button class="perfil-pedido-card__producto-mas" (click)="mostrarMasProductos(pedido.id)" type="button">
          <span>+{{ pedido.productos.length - limiteProductosVisibles }} más</span>
        </button>
        }
      </div>
      @if (pedido.datosEntrega && (pedido.datosEntrega.idJugador || pedido.datosEntrega.idServer) &&
      mostrarTodosProductos(pedido.id)) {
      <div class="perfil-pedido-card__detalle">
        @if (pedido.datosEntrega.idJugador) {
        <p class="perfil-pedido-card__detalle-item"><strong>ID Jugador:</strong> {{ pedido.datosEntrega.idJugador }}</p>
        }
        @if (pedido.datosEntrega.idServer) {
        <p class="perfil-pedido-card__detalle-item"><strong>ID Servidor:</strong> {{ pedido.datosEntrega.idServer }}</p>
        }
      </div>
      }
      <div class="perfil-pedido-card__footer">
        <div class="perfil-pedido-card__resumen">
          <div class="perfil-pedido-card__resumen-item">
            <span class="perfil-pedido-card__resumen-label">Productos:</span>
            <span class="perfil-pedido-card__resumen-valor">{{ pedido.productos.length }}</span>
          </div>
          <div class="perfil-pedido-card__resumen-item perfil-pedido-card__resumen-item--total">
            <span class="perfil-pedido-card__resumen-label">Total:</span>
            <span class="perfil-pedido-card__total-monto">${{ pedido.total_compra }} USD</span>
          </div>
        </div>
      </div>
    </div>
    } @empty {
    <div class="perfil-pedidos-vacio">
      <img src="/iconos/ico-orden.svg" alt="Sin pedidos" class="perfil-pedidos-vacio__icono">
      <p class="perfil-pedidos-vacio__texto">Empieza con tu primera compra de recarga directa</p>
    </div>
    }
  </div>
</div>
}

<!-- Pedidos Gift Card -->
@if (tipoPedidoVista() === 'gift_cards') {
<div class="perfil-pedidos-apartado">
  <h3 class="perfil-pedidos-apartado__titulo">Pedidos Gift Card (códigos manuales)</h3>
  @if (!identidadVerificada()) {
  <div class="perfil-pedidos-gift-bloque">
    <p class="perfil-pedidos-gift-aviso">Para ver tus códigos PIN debes verificar tu identidad.</p>
    <button class="perfil-pedidos-gift-boton" (click)="verCodigosGiftCard()" type="button">
      <img src="/iconos/ico-codigo.svg" alt="" class="perfil-pedidos-gift-boton__icono"> Ver códigos Gift Card
    </button>
  </div>
  }
  @if (identidadVerificada()) {
  <div class="perfil-pedidos">
    @for (pedido of pedidosGiftCardFiltrados(); track pedido.id) {
    <div class="perfil-gift-card">
      <div class="perfil-gift-card__header">
        <h4 class="perfil-gift-card__nombre">{{ pedido.nombre }}</h4>
        <p class="perfil-gift-card__fecha">Fecha de emisión: {{ pedido.fechaEmision | date:'d MMM yyyy, h:mm a' }}</p>
      </div>
      <div class="perfil-gift-card__codigos">
        @for (codigo of pedido.codigos; track $index) {
        <div class="perfil-gift-card__codigo-fila">
          <span class="perfil-gift-card__codigo-serial">Serial: {{ codigo.serial ?? 'N/A' }}</span>
          <span class="perfil-gift-card__codigo-pin">PIN: {{ codigo.pin ?? 'N/A' }}</span>
          <button type="button" class="perfil-gift-card__copiar"
            (click)="copiarCodigoIndividual((codigo.serial ?? '') + ' ' + (codigo.pin ?? ''))" title="Copiar">
            <img src="/iconos/ico-copiar.svg" alt="Copiar" class="perfil-gift-card__copiar-icono">
          </button>
        </div>
        }
      </div>
      <div class="perfil-gift-card__valor">Valor total: ${{ pedido.valorTotal }} USD</div>
      <div class="perfil-gift-card__instrucciones-bloque">
        <span class="perfil-gift-card__instrucciones-label">Instrucciones</span>
        <p class="perfil-gift-card__instrucciones">{{ pedido.instrucciones || 'Sin instrucciones específicas.' }}</p>
      </div>
      <button type="button" class="perfil-gift-card__copiar-todo" (click)="copiarTodoGiftCard(pedido)"
        title="Copia todos los códigos, valor e instrucciones">
        <img src="/iconos/ico-copiar.svg" alt="Copiar todo" class="perfil-gift-card__copiar-icono"> Copiar todo
      </button>
    </div>
    } @empty {
    <div class="perfil-pedidos-vacio">
      <img src="/iconos/ico-codigo.svg" alt="Sin Gift Cards" class="perfil-pedidos-vacio__icono">
      <p class="perfil-pedidos-vacio__texto">Empieza con tu primera compra de Gift Card</p>
    </div>
    }
  </div>
  }
</div>
}

<!-- Modal verificar identidad -->
<app-modal [estaAbierto]="modalVerificarIdentidadAbierto()" (cerrar)="cerrarModalVerificarIdentidad()">
  <div class="perfil-modal-verificar">
    <div class="perfil-modal-verificar__icono">
      <img src="/iconos/ico-configuracion.svg" alt="" aria-hidden="true">
    </div>
    <h3 class="perfil-modal-verificar__titulo">Verificar Identidad</h3>
    <p class="perfil-modal-verificar__descripcion">Para acceder a tus códigos PIN de forma segura, ingresa la
      contraseña de tu cuenta.</p>
    <label class="perfil-modal-verificar__label">Contraseña</label>
    <div class="global-formulario-campo">
      <div class="global-formulario-campo__contenedor">
        <input type="password" class="global-formulario-campo__input" placeholder="Ingresa tu contraseña"
          [value]="contrasenaVerificacion()" (input)="actualizarContrasenaVerificacion($event)">
      </div>
    </div>
    <div class="perfil-modal-verificar__acciones">
      <button type="button" class="perfil-modal-verificar__cancelar" (click)="cerrarModalVerificarIdentidad()">Cancelar</button>
      <button type="button" class="perfil-modal-verificar__verificar" (click)="verificarIdentidad()">Verificar</button>
    </div>
  </div>
</app-modal>
