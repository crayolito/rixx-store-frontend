<div class="perfil-contenedor">
  <!-- ─── BANNER SUPERIOR CON FOTO DE PERFIL ─── -->
  <div class="perfil-banner">
    <div class="perfil-banner__contenido">
      <div class="perfil-banner__foto-contenedor">
        <label for="input-foto-perfil" class="perfil-banner__foto-label">
          @if (fotoPerfil() && fotoPerfil() !== '/imagenes/usuarios/default.jpg') {
          <img [src]="fotoPerfil()" alt="Foto de perfil" class="perfil-banner__foto">
          } @else {
          <img src="/imagenes/foto-perfil1.png" alt="Foto por defecto" class="perfil-banner__foto">
          }
          <div class="perfil-banner__foto-overlay">
            <img src="/iconos/foto-perfil1.svg" alt="Editar" class="perfil-banner__foto-icono">
          </div>
        </label>
        <input type="file" id="input-foto-perfil" accept="image/*" (change)="manejarCambioFoto($event)"
          style="display: none;">
      </div>
      <div class="perfil-banner__info">
        <h1 class="perfil-banner__nombre">{{ nombre() }}</h1>
        <p class="perfil-banner__email">{{ email() }}</p>
      </div>
    </div>
  </div>

  <!-- ─── LAYOUT PRINCIPAL ─── -->
  <div class="perfil-layout">
    <!-- ─── MENÚ LATERAL ─── -->
    <aside class="perfil-menu">
      <nav class="perfil-menu__navegacion">
        <button class="perfil-menu__opcion" [class.perfil-menu__opcion--activa]="seccionActiva() === 'perfil'"
          (click)="cambiarSeccion('perfil')" type="button">
          <img src="/iconos/ico-cliente.svg" alt="Perfil" class="perfil-menu__icono">
          <span>Mi Perfil</span>
        </button>
        <button class="perfil-menu__opcion" [class.perfil-menu__opcion--activa]="seccionActiva() === 'pedidos'"
          (click)="cambiarSeccion('pedidos')" type="button">
          <img src="/iconos/ico-orden.svg" alt="Pedidos" class="perfil-menu__icono">
          <span>Mis Pedidos</span>
        </button>
        <button class="perfil-menu__opcion" [class.perfil-menu__opcion--activa]="seccionActiva() === 'billetera'"
          (click)="cambiarSeccion('billetera')" type="button">
          <img src="/iconos/ico-billetera.svg" alt="Billetera" class="perfil-menu__icono">
          <span>Billetera</span>
        </button>
      </nav>
    </aside>

    <!-- ─── CONTENIDO PRINCIPAL ─── -->
    <main class="perfil-contenido">
      <!-- ═══════════════════════════════════════════════════════
           SECCIÓN: MI PERFIL
           ═══════════════════════════════════════════════════════ -->
      @if (seccionActiva() === 'perfil') {
      <section class="perfil-seccion">
        <div class="perfil-seccion__header">
          <h2 class="perfil-seccion__titulo">Información Personal</h2>
          <p class="perfil-seccion__subtitulo">Administra tu información de cuenta</p>
        </div>

        <div class="perfil-datos">
          <!-- Datos básicos del usuario -->
          <div class="perfil-datos__grid">
            <div class="perfil-dato-card">
              <div class="perfil-dato-card__header">
                <img src="/iconos/ico-cliente.svg" alt="Nombre" class="perfil-dato-card__icono">
                <span class="perfil-dato-card__label">Nombre completo</span>
              </div>
              @if (!estaEditando()) {
              <p class="perfil-dato-card__valor">{{ nombre() }}</p>
              } @else {
              <div class="global-formulario-campo">
                <div class="global-formulario-campo__contenedor">
                  <input type="text" class="global-formulario-campo__input" placeholder="Ej: Juan Pérez García"
                    [value]="nombreTemporal()" (input)="actualizarNombre($event)">
                </div>
              </div>
              }
            </div>

            <div class="perfil-dato-card">
              <div class="perfil-dato-card__header">
                <img src="/iconos/ico-marketing.svg" alt="Email" class="perfil-dato-card__icono">
                <span class="perfil-dato-card__label">Correo electrónico</span>
              </div>
              @if (!estaEditando()) {
              <p class="perfil-dato-card__valor">{{ email() }}</p>
              } @else {
              <div class="global-formulario-campo">
                <div class="global-formulario-campo__contenedor">
                  <input type="email" class="global-formulario-campo__input" placeholder="Ej: usuario@ejemplo.com"
                    [value]="emailTemporal()" (input)="actualizarEmail($event)">
                </div>
              </div>
              }
            </div>
          </div>

          <!-- Botón Editar/Guardar -->
          <div class="perfil-datos__acciones">
            @if (!estaEditando()) {
            <button class="boton-primario perfil-billetera__boton" (click)="activarEdicion()" type="button">
              <p>Editar Información</p>
            </button>
            } @else {
            <div class="perfil-datos__botones-edicion">
              <button class="boton-secundario perfil-billetera__boton" (click)="cancelarEdicion()" type="button">
                <p>Cancelar</p>
              </button>
              <button class="boton-primario perfil-billetera__boton" (click)="guardarCambios()" type="button">
                <p>Guardar Cambios</p>
              </button>
            </div>
            }
          </div>

          <!-- Sección de contraseña con toggle -->
          <div class="perfil-contrasena-seccion">
            <div class="perfil-contrasena-seccion__header">
              <div class="perfil-contrasena-seccion__info">
                <img src="/iconos/ico-configuracion.svg" alt="Contraseña" class="perfil-contrasena-seccion__icono">
                <span class="perfil-contrasena-seccion__titulo">Seguridad de la cuenta</span>
              </div>
              <label class="perfil-toggle">
                <input type="checkbox" class="perfil-toggle__input" [checked]="mostrarCambioContrasena()"
                  (change)="toggleCambioContrasena()">
                <span class="perfil-toggle__slider"></span>
              </label>
            </div>

            <!-- Contenido cuando está activado -->
            @if (mostrarCambioContrasena()) {
            <div class="perfil-contrasena-contenido">
              @if (ingresoPorGoogle()) {
              <!-- Mensaje para usuarios de Google -->
              <div class="perfil-mensaje-google">
                <img src="/imagenes/logo-google.png" alt="Google" class="perfil-mensaje-google__logo">
                <div class="perfil-mensaje-google__contenido">
                  <h4 class="perfil-mensaje-google__titulo">Cambio de contraseña no disponible</h4>
                  <p class="perfil-mensaje-google__texto">
                    Esta cuenta está vinculada con Google, por lo que no es posible cambiar la contraseña. Si deseas
                    cambiar tu contraseña, puedes hacerlo directamente desde tu cuenta de Google.
                  </p>
                </div>
              </div>
              }
              <!-- Formulario para cambiar contraseña (siempre visible) -->
              <div class="perfil-formulario-contrasena">
                <div class="perfil-datos__grid">
                  <div class="perfil-dato-card">
                    <div class="perfil-dato-card__header">
                      <img src="/iconos/ico-configuracion.svg" alt="Contraseña" class="perfil-dato-card__icono">
                      <span class="perfil-dato-card__label">Contraseña actual</span>
                    </div>
                    <div class="global-formulario-campo">
                      <div class="global-formulario-campo__contenedor">
                        <input type="password" class="global-formulario-campo__input" placeholder="••••••••">
                      </div>
                    </div>
                  </div>
                  <div class="perfil-dato-card">
                    <div class="perfil-dato-card__header">
                      <img src="/iconos/ico-configuracion.svg" alt="Nueva contraseña" class="perfil-dato-card__icono">
                      <span class="perfil-dato-card__label">Nueva contraseña</span>
                    </div>
                    <div class="global-formulario-campo">
                      <div class="global-formulario-campo__contenedor">
                        <input [type]="mostrarContrasena() ? 'text' : 'password'" class="global-formulario-campo__input"
                          placeholder="••••••••" [value]="contrasena()" (input)="actualizarContrasena($event)">
                        <button type="button" class="global-formulario-campo__boton-icono"
                          (click)="toggleMostrarContrasena()">
                          <img
                            [src]="mostrarContrasena() ? '/iconos/ico-ojo-cerrado.svg' : '/iconos/ico-ojo-abierto.svg'"
                            [alt]="mostrarContrasena() ? 'Ocultar' : 'Mostrar'" class="icono-boton icono-color-blanco">
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                <button class="boton-primario perfil-billetera__boton" (click)="guardarPerfil()" type="button">
                  <p>Cambiar Contraseña</p>
                </button>
              </div>
            </div>
            }
          </div>
        </div>
      </section>
      }

      <!-- ═══════════════════════════════════════════════════════
           SECCIÓN: HISTORIAL DE PEDIDOS
           ═══════════════════════════════════════════════════════ -->
      @if (seccionActiva() === 'pedidos') {
      <section class="perfil-seccion">
        <div class="perfil-seccion__header">
          <h2 class="perfil-seccion__titulo">Historial de Pedidos</h2>
          <p class="perfil-seccion__subtitulo">Revisa tus compras anteriores</p>
        </div>

        <div class="perfil-pedidos">
          @for (pedido of pedidos(); track pedido.id) {
          <div class="perfil-pedido-card">
            <!-- Header del pedido -->
            <div class="perfil-pedido-card__header">
              <div class="perfil-pedido-card__header-info">
                <p class="perfil-pedido-card__id">Pedido #{{ truncarTexto(pedido.id, 12) }}</p>
                <p class="perfil-pedido-card__fecha">{{ pedido.fecha_compra | date:'d MMM yyyy, h:mm a' }}</p>
              </div>
              <span class="perfil-pedido-card__badge perfil-pedido-card__badge--{{pedido.estado}}">
                {{ pedido.estado }}
              </span>
            </div>

            <!-- Productos con imagen y cantidad -->
            <div class="perfil-pedido-card__productos">
              @for (prod of pedido.productos; track prod.id; let index = $index) {
              @if (index < 4 || mostrarTodosProductos(pedido.id)) { <div class="perfil-pedido-card__producto">
                <img [src]="prod.imagen || '/imagenes/producto-default.png'" [alt]="prod.nombre"
                  class="perfil-pedido-card__producto-imagen">
                <div class="perfil-pedido-card__producto-info">
                  <p class="perfil-pedido-card__producto-nombre">{{ prod.nombre }}</p>
                  <p class="perfil-pedido-card__producto-cantidad">Cantidad: {{ prod.cantidad }}</p>
                </div>
            </div>
            }
            }
            @if (pedido.productos.length > 4 && !mostrarTodosProductos(pedido.id)) {
            <button class="perfil-pedido-card__producto-mas" (click)="mostrarMasProductos(pedido.id)" type="button">
              <span>+{{ pedido.productos.length - 4 }} más</span>
            </button>
            }
          </div>

          <!-- Resumen y Total -->
          <div class="perfil-pedido-card__footer">
            <div class="perfil-pedido-card__resumen">
              <div class="perfil-pedido-card__resumen-item">
                <span class="perfil-pedido-card__resumen-label">Productos:</span>
                <span class="perfil-pedido-card__resumen-valor">{{ pedido.productos.length }}</span>
              </div>
              <div class="perfil-pedido-card__resumen-item">
                <span class="perfil-pedido-card__resumen-label">Fecha:</span>
                <span class="perfil-pedido-card__resumen-valor">{{ pedido.fecha_compra | date:'d MMM yyyy' }}</span>
              </div>
              <div class="perfil-pedido-card__resumen-item perfil-pedido-card__resumen-item--total">
                <span class="perfil-pedido-card__resumen-label">Total:</span>
                <span class="perfil-pedido-card__total-monto">${{ pedido.total_compra }} USD</span>
              </div>
            </div>
          </div>
        </div>
        } @empty {
        <div class="perfil-pedidos-vacio">
          <img src="/iconos/ico-orden.svg" alt="Sin pedidos" class="perfil-pedidos-vacio__icono">
          <h3 class="perfil-pedidos-vacio__titulo">No tienes pedidos aún</h3>
          <p class="perfil-pedidos-vacio__texto">Explora nuestro catálogo y realiza tu primera compra</p>
        </div>
        }
  </div>
  </section>
  }

  <!-- ═══════════════════════════════════════════════════════
           SECCIÓN: BILLETERA
           ═══════════════════════════════════════════════════════ -->
  @if (seccionActiva() === 'billetera') {
  <section class="perfil-seccion">
    <div class="perfil-seccion__header">
      <h2 class="perfil-seccion__titulo">Mi Billetera</h2>
      <p class="perfil-seccion__subtitulo">Administra tu saldo y recargas</p>
    </div>

    <!-- Tarjeta de Saldo -->
    <div class="perfil-billetera-saldo">
      <div class="perfil-billetera-saldo__contenido">
        <p class="perfil-billetera-saldo__etiqueta">Saldo Disponible</p>
        <p class="perfil-billetera-saldo__monto">${{ saldoActual() }}</p>
        <p class="perfil-billetera-saldo__moneda">US Dollars</p>
      </div>
      <div class="perfil-billetera-saldo__decoracion"></div>
    </div>

    <!-- Paquetes de recarga -->
    <div class="perfil-billetera-paquetes">
      <label class="perfil-billetera-paquetes__etiqueta">Selecciona un monto</label>
      <div class="perfil-billetera-paquetes__grid">
        @for (paquete of paquetes; track paquete.id) {
        <button class="perfil-billetera-paquete"
          [class.perfil-billetera-paquete--activo]="paqueteSeleccionado()?.id === paquete.id"
          (click)="seleccionarPaquete(paquete)" type="button">
          <span class="perfil-billetera-paquete__monto">${{ paquete.monto }}</span>
          <span class="perfil-billetera-paquete__moneda">USD</span>
        </button>
        }
      </div>

      <!-- Cantidad personalizada -->
      <div class="perfil-billetera-custom">
        <label class="perfil-billetera-custom__etiqueta">O ingresa un monto personalizado</label>
        <div class="perfil-billetera-custom__input-contenedor">
          <span class="perfil-billetera-custom__simbolo">$</span>
          <input type="number" class="perfil-billetera-custom__input" placeholder="0.00" min="0" step="0.01"
            [value]="cantidadEspecial()" (input)="actualizarCantidadEspecial($event)"
            (focus)="seleccionarPaquete(null)">
          <span class="perfil-billetera-custom__moneda">USD</span>
        </div>
      </div>
    </div>

    <!-- Métodos de pago -->
    <div class="perfil-billetera-metodos">
      <label class="perfil-billetera-metodos__etiqueta">Método de pago</label>
      <div class="perfil-billetera-metodos__lista">
        @for (metodo of metodosPago; track metodo.id) {
        <label class="perfil-billetera-metodo-card">
          <div class="perfil-billetera-metodo-card__contenido">
            <input type="radio" class="perfil-billetera-metodo-card__radio" name="metodo-pago" [value]="metodo.id"
              [checked]="metodoPagoSeleccionado() === metodo.id" (change)="seleccionarMetodoPago(metodo.id)">
            <img [src]="metodo.logo" [alt]="metodo.nombre" class="perfil-billetera-metodo-card__logo">
            <div class="perfil-billetera-metodo-card__info">
              <p class="perfil-billetera-metodo-card__nombre">{{ metodo.nombre }}</p>
              <p class="perfil-billetera-metodo-card__descripcion">{{ metodo.descripcion }}</p>
            </div>
          </div>
        </label>
        }
      </div>
    </div>

    <!-- Botón recargar -->
    <button class="boton-primario perfil-billetera__boton" (click)="recargarBilletera()" [disabled]="!puedeRecargar()"
      type="button">
      <p>Recargar Ahora</p>
    </button>
  </section>
  }
  </main>
</div>
</div>
