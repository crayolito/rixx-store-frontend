<div class="contenedor-pagina">
  <section class="encabezado-admin-seccion encabezado-admin-tarjeta">
    <div class="encabezado-admin-cabecera-principal">
      <div class="encabezado-admin-titulo-contenedor">
        <h2 class="encabezado-admin-titulo">Encabezado</h2>
        @if (hayCambiosPendientes()) {
        <span class="encabezado-admin-cambios-sin-guardar">• Cambios sin guardar</span>
        }
      </div>
      <div class="encabezado-admin-botones-cabecera">
        <button type="button" class="boton-secundario" (click)="volver()">Volver</button>
        @if (hayCambiosPendientes()) {
        <button type="button" class="boton-secundario" (click)="cancelarCambios()" [disabled]="guardando()">Cancelar</button>
        }
        <button type="button" class="boton-primario" (click)="guardarConfiguracion()" [disabled]="guardando()">
          {{ guardando() ? 'Guardando...' : 'Guardar' }}
        </button>
      </div>
    </div>
    <div class="encabezado-admin-fila-promocion-logo">
      <div class="global-formulario-campo encabezado-admin-campo-promocion">
        <label class="global-formulario-campo__etiqueta">Promoción</label>
        <div class="global-formulario-campo__contenedor">
          <input type="text" class="global-formulario-campo__input"
            placeholder="Ej: ¡Buen año! ¡Promociones especiales!" [value]="tituloPromocion()"
            (input)="tituloPromocion.set($any($event.target).value)">
        </div>
      </div>
      <div class="formulario-imagenes encabezado-admin-campo-logo">
        <label class="global-formulario-campo__etiqueta">Logo</label>
        <div class="formulario-imagenes__contenedor-imagenes">
          <label for="input-logo-encabezado"
            class="global-formulario-imagenes__contenedor global-formulario-imagenes__contenedor--clickeable">
            @if (logoUrl()) {
            <img [src]="logoUrl()" alt="Logo" class="global-formulario-imagenes__preview">
            } @else {
            <img src="/iconos/ico-imagen.svg" alt="Icono imagen" class="icono-boton icono-color-secundario">
            <span class="global-formulario-imagenes__etiqueta1">Haz clic para subir el logo</span>
            <span class="global-formulario-imagenes__etiqueta2">PNG, JPG, SVG hasta 5MB</span>
            }
          </label>
          <input type="file" id="input-logo-encabezado" accept="image/*" (change)="manejarCambioLogo($event)"
            style="display: none;">
        </div>
      </div>
    </div>
  </section>

  <section class="encabezado-admin-seccion encabezado-admin-tarjeta">
    <div class="encabezado-admin-seccion-cabecera">
      <h2 class="encabezado-admin-titulo">Secciones del encabezado</h2>
      @if (puedeAgregarSeccion()) {
      <button type="button" class="boton-primario" (click)="agregarSeccion()">Agregar sección</button>
      }
    </div>
    <p class="encabezado-admin-ayuda">Mínimo {{ minSecciones }}, máximo {{ maxSecciones }}. Si no pones texto base,
      debes elegir una categoría para redirigir. Si marcas "Dinámico", se muestra un dropdown con las categorías que
      elijas (usa el buscador si hay muchas).</p>

    @for (seccion of secciones(); track seccion.id; let i = $index) {
    <div class="encabezado-admin-seccion-item"
      [class.encabezado-admin-seccion-item--invalida]="seccionInvalida(seccion)">
      <div class="encabezado-admin-seccion-item-cabecera">
        <span class="encabezado-admin-seccion-item-numero">Sección {{ i + 1 }}</span>
        <div class="encabezado-admin-orden-y-quitar">
          <div class="encabezado-admin-botones-orden">
            <button type="button" class="boton-secundario encabezado-admin-boton-orden" title="Subir"
              [disabled]="i === 0" (click)="moverSeccionArriba(i)">↑</button>
            <button type="button" class="boton-secundario encabezado-admin-boton-orden" title="Bajar"
              [disabled]="i === secciones().length - 1" (click)="moverSeccionAbajo(i)">↓</button>
          </div>
          @if (puedeQuitarSeccion()) {
          <button type="button" class="boton-secundario encabezado-admin-boton-quitar"
            (click)="quitarSeccion(i)">Quitar</button>
          }
        </div>
      </div>

      <div class="global-formulario-campo">
        <label class="global-formulario-campo__etiqueta">Texto base (título de la sección)</label>
        <div class="global-formulario-campo__contenedor">
          <input type="text" class="global-formulario-campo__input" placeholder="Ej: Categorías"
            [value]="seccion.tituloBase" (input)="actualizarTituloBase(i, $any($event.target).value)">
        </div>
      </div>

      <div class="encabezado-admin-checkbox-contenedor">
        <label class="encabezado-admin-checkbox">
          <input type="checkbox" [checked]="seccion.esDinamico"
            (change)="actualizarDinamico(i, $any($event.target).checked)">
          <span class="encabezado-admin-checkbox-texto">Dinámico (dropdown en lugar de redirigir al hacer clic)</span>
        </label>
      </div>

      @if (!seccion.esDinamico) {
      <label class="global-formulario-campo__etiqueta">Redirigir a categoría</label>
      @if (seccion.redireccionCategoria) {
      <p class="encabezado-admin-seleccionado">Seleccionado: {{ seccion.redireccionCategoria.titulo }}</p>
      }
      <div class="encabezado-admin-buscador-contenedor">
        <img src="/iconos/ico-busqueda.svg" alt="" class="encabezado-admin-buscador-icono">
        <input type="text" class="global-formulario-campo__input encabezado-admin-buscador-input"
          placeholder="Buscar categoría..." [value]="busquedaRedireccion()[i] || ''"
          (input)="setBusquedaRedireccion(i, $any($event.target).value)">
      </div>
      <div class="encabezado-admin-lista-categorias">
        @for (cat of categoriasFiltradasParaRedireccion(i); track cat.id) {
        <button type="button" class="encabezado-admin-opcion-categoria"
          [class.encabezado-admin-opcion-categoria--activa]="seccion.redireccionCategoria?.handle === cat.handle"
          (click)="actualizarRedireccion(i, cat)">
          {{ handleATitulo(cat.handle) }}
        </button>
        }
        @if (categorias().length === 0) {
        <span class="encabezado-admin-sin-resultados">No hay categorías disponibles.</span>
        } @else if (categoriasFiltradasParaRedireccion(i).length === 0) {
        <span class="encabezado-admin-sin-resultados">Ninguna categoría coincide con la búsqueda.</span>
        }
      </div>
      @if (!(seccion.tituloBase || '').trim() && !seccion.redireccionCategoria) {
      <span class="encabezado-admin-error">Sin texto base debes elegir una categoría.</span>
      }
      } @else {
      <label class="global-formulario-campo__etiqueta">Categorías dentro de esta sección (dropdown para el
        cliente)</label>
      <div class="encabezado-admin-buscador-contenedor">
        <img src="/iconos/ico-busqueda.svg" alt="" class="encabezado-admin-buscador-icono">
        <input type="text" class="global-formulario-campo__input encabezado-admin-buscador-input"
          placeholder="Buscar categoría..." [value]="busquedaCategorias()[i] || ''"
          (input)="setBusquedaCategorias(i, $any($event.target).value)">
      </div>
      <div class="encabezado-admin-categorias-opciones">
        @for (cat of categoriasFiltradasParaSeccion(i); track cat.id) {
        <label class="encabezado-admin-checkbox encabezado-admin-checkbox--opcion">
          <input type="checkbox" [checked]="categoriaSeleccionadaEnSeccion(seccion, cat.handle)"
            (change)="toggleCategoriaEnSeccion(i, cat)">
          <span class="encabezado-admin-checkbox-texto">{{ handleATitulo(cat.handle) }}</span>
        </label>
        }
        @if (categorias().length === 0) {
        <span class="encabezado-admin-sin-resultados">No hay categorías disponibles.</span>
        } @else if (categoriasFiltradasParaSeccion(i).length === 0) {
        <span class="encabezado-admin-sin-resultados">Ninguna categoría coincide con la búsqueda.</span>
        }
      </div>
      @if ((seccion.categorias ?? []).length === 0) {
      <span class="encabezado-admin-error">Elige al menos una categoría para el dropdown.</span>
      }
      }
    </div>
    }
  </section>
</div>