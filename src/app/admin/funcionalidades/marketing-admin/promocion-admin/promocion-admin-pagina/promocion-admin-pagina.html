<div class="contenedor-pagina">
  <section class="promocion-admin-seccion promocion-admin-tarjeta">
    <div class="promocion-admin-cabecera-principal">
      <div class="promocion-admin-titulo-contenedor">
        <h2 class="promocion-admin-titulo">Promoción</h2>
        @if (hayCambiosPendientes()) {
        <span class="promocion-admin-cambios-sin-guardar">• Cambios sin guardar</span>
        }
      </div>
      <div class="promocion-admin-botones-cabecera">
        <button type="button" class="boton-secundario" (click)="volver()">Volver</button>
        @if (hayCambiosPendientes()) {
        <button type="button" class="boton-secundario" (click)="cancelarCambios()" [disabled]="guardando()">Descartar</button>
        }
        <button type="button" class="boton-primario" (click)="guardarConfiguracion()" [disabled]="guardando()">
          {{ guardando() ? 'Guardando...' : 'Guardar' }}
        </button>
      </div>
    </div>

    <div class="global-formulario-campo">
      <label class="global-formulario-campo__etiqueta">Título de la sección</label>
      <div class="global-formulario-campo__contenedor">
        <input type="text" class="global-formulario-campo__input"
          placeholder="Ej: Productos en promoción" [value]="titulo()"
          (input)="titulo.set($any($event.target).value)">
      </div>
    </div>

    <p class="promocion-admin-ayuda">Mínimo {{ minItems }} ítems, máximo {{ maxItems }}. Los elegidos se muestran arriba; la búsqueda solo filtra los productos que puedes agregar.</p>

    <h3 class="promocion-admin-titulo-secundario">Productos elegidos ({{ items().length }})</h3>
    @if (items().length < minItems) {
    <p class="promocion-admin-alerta">Agrega al menos {{ minItems }} productos.</p>
    }
    <p class="promocion-admin-hint">Arrastra para cambiar el orden.</p>
    <div class="promocion-admin-lista-elegidos">
      @for (item of items(); track item.handle; let i = $index) {
      <div class="promocion-admin-item-elegido"
        [class.promocion-admin-item-elegido--arrastrando]="estaArrastrando(i)"
        draggable="true"
        (dragstart)="iniciarArrastre($event, i)"
        (dragover)="permitirSoltar($event)"
        (drop)="soltar($event, i)"
        (dragend)="finArrastre()">
        <div class="promocion-admin-item-arrastrar" title="Arrastra para ordenar">
          <img src="/iconos/icon-opciones.svg" alt="" class="promocion-admin-icono-arrastrar">
        </div>
        <span class="promocion-admin-item-titulo">{{ item.titulo }}</span>
        <span class="promocion-admin-item-categoria">{{ categoriasParaItem(item) }}</span>
        <button type="button" class="boton-secundario promocion-admin-boton-quitar"
          [disabled]="items().length <= minItems" (click)="quitarItem(i)">
          Quitar
        </button>
      </div>
      }
      @if (items().length === 0) {
      <p class="promocion-admin-sin-elegidos">Aún no hay productos elegidos. Busca y agrega abajo.</p>
      }
    </div>

    <h3 class="promocion-admin-titulo-secundario">Buscar y agregar productos</h3>
    <div class="promocion-admin-buscador-contenedor">
      <img src="/iconos/ico-busqueda.svg" alt="" class="promocion-admin-buscador-icono">
      <input type="text" class="global-formulario-campo__input promocion-admin-buscador-input"
        placeholder="Buscar producto..." [value]="textoBusqueda()"
        (input)="setBusqueda($any($event.target).value)">
    </div>
    <div class="promocion-admin-lista-productos">
      @for (p of productosPaginados(); track p.handle) {
      <div class="promocion-admin-fila-producto">
        <label class="promocion-admin-checkbox">
          <input type="checkbox" [disabled]="!puedeSeleccionarMas()" (change)="toggleSeleccion(p)">
        </label>
        <span class="promocion-admin-fila-titulo">{{ p.titulo }}</span>
        <span class="promocion-admin-fila-categorias">{{ categoriasTexto(p) }}</span>
        <button type="button" class="boton-secundario promocion-admin-boton-agregar"
          [disabled]="!puedeSeleccionarMas()" (click)="toggleSeleccion(p)">
          Agregar
        </button>
      </div>
      }
      @if (productosPaginados().length === 0) {
      <p class="promocion-admin-sin-resultados">
        {{ items().length >= productosDisponibles().length ? 'Todos los productos ya están elegidos.' : 'Ningún producto coincide con la búsqueda.' }}
      </p>
      }
    </div>
    <div class="promocion-admin-paginacion">
      <button type="button" class="boton-secundario" [disabled]="paginaActual() <= 1"
        (click)="irAPagina(paginaActual() - 1)">Anterior</button>
      <span class="promocion-admin-paginacion-info">
        Página {{ paginaActual() }} de {{ totalPaginas() }}
      </span>
      <button type="button" class="boton-secundario" [disabled]="paginaActual() >= totalPaginas()"
        (click)="irAPagina(paginaActual() + 1)">Siguiente</button>
    </div>
  </section>
</div>
