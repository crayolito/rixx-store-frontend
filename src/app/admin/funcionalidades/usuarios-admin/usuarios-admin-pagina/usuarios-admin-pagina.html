<div class="lista-usuarios-contenedor" (click)="cerrarTodosLosDropdowns()">
  <!-- ===== SECCIÓN: TITULO Y OPCIONES ===== -->
  <section class="titulo-opciones-contenedor">
    <div class="titulo-contenedor">
      <img src="/iconos/ico-cliente.svg" alt="Icono usuarios" class="icono-boton icono-color-base">
      <h3>Usuarios</h3>
    </div>
    <div class="opciones-contenedor">
      <button class="boton-secundario" (click)="alternarFiltros()">
        <p>{{ filtrosVisibles() ? 'Ocultar Filtros' : 'Mostrar Filtros' }}</p>
      </button>
      <button class="boton-primario" (click)="abrirModalCrear()">
        <p>Agregar usuario</p>
      </button>
    </div>
  </section>

  <!-- ===== SECCIÓN: FILTROS Y BÚSQUEDA ===== -->
  @if (filtrosVisibles()) {
  <section class="global-filtros" (click)="$event.stopPropagation()">
    <!-- Búsqueda unificada -->
    <div class="global-filtros__item">
      <p class="global-filtros__titulo">Buscar usuario</p>
      <div class="global-filtros__busqueda">
        <img src="/iconos/ico-busqueda.svg" alt="Icono busqueda" class="icono-boton icono-color-base">
        <input type="text" placeholder="Buscar por nombre o correo..." class="global-filtros__input"
          [value]="textoBusqueda()" (input)="actualizarBusqueda($event)">
      </div>
    </div>

    <!-- Filtro Estado -->
    <div class="global-filtros__item">
      <p class="global-filtros__titulo">Estado</p>
      <div class="global-filtros__dropdown" (click)="$event.stopPropagation()">
        <button class="global-filtros__dropdown-boton" (click)="alternarEstado()" type="button">
          <span>{{ estadoSeleccionado() }}</span>
          <img src="/iconos/ico-flecha-abajo-opciones.svg" alt="Flecha" class="icono-boton icono-color-base">
        </button>
        @if (dropdownEstadoAbierto()) {
        <div class="global-filtros__dropdown-menu">
          @for (opcion of opcionesEstado; track opcion) {
          <button class="global-filtros__dropdown-opcion" (click)="seleccionarEstado(opcion)" type="button">
            {{ opcion }}
          </button>
          }
        </div>
        }
      </div>
    </div>

    <!-- Filtro Rol -->
    <div class="global-filtros__item">
      <p class="global-filtros__titulo">Rol</p>
      <div class="global-filtros__dropdown" (click)="$event.stopPropagation()">
        <button class="global-filtros__dropdown-boton" (click)="alternarRol()" type="button">
          <span>{{ rolSeleccionado() }}</span>
          <img src="/iconos/ico-flecha-abajo-opciones.svg" alt="Flecha" class="icono-boton icono-color-base">
        </button>
        @if (dropdownRolAbierto()) {
        <div class="global-filtros__dropdown-menu">
          @for (opcion of opcionesRol(); track opcion) {
          <button class="global-filtros__dropdown-opcion" (click)="seleccionarRol(opcion)" type="button">
            {{ opcion }}
          </button>
          }
        </div>
        }
      </div>
    </div>

    <!-- Filtro Último acceso (selector de fecha) -->
    <div class="global-filtros__item">
      <p class="global-filtros__titulo">Último acceso</p>
      <div class="global-filtros__busqueda global-filtros__campo-fecha">
        <input type="date" class="global-filtros__input"
          [value]="fechaUltimoAcceso()" (change)="actualizarFiltroFechaUltimoAcceso($event)">
        @if (fechaUltimoAcceso()) {
        <button type="button" class="global-filtros__limpiar-fecha" (click)="limpiarFiltroFechaUltimoAcceso()"
          aria-label="Quitar filtro de fecha">
          <img src="/iconos/ico-limpiar.svg" alt="Limpiar" class="icono-boton icono-color-base">
        </button>
        }
      </div>
    </div>

    <!-- Botón limpiar filtros -->
    <div class="global-filtros__item">
      <button class="boton-secundario global-filtros__boton-icono" (click)="limpiarFiltros()" type="button"
        aria-label="Limpiar filtros">
        <img src="/iconos/ico-limpiar.svg" alt="Icono limpiar filtros" class="icono-boton icono-color-base">
      </button>
    </div>
  </section>
  }

  <!-- ===== SECCIÓN: TABLA DE USUARIOS ===== -->
  <section class="global-tabla">
    @if (estaCargando()) {
      <app-bloque-estado-tabla estado="cargando" mensajeCarga="Cargando usuarios..." />
    } @else if (usuariosPaginados().length === 0) {
      <app-bloque-estado-tabla
        estado="vacio"
        tituloVacio="No se encontraron usuarios"
        textoVacio="No hay usuarios registrados o los filtros no coinciden con ningún resultado. Prueba ajustando los filtros o agrega un nuevo usuario."
        iconoVacio="/iconos/ico-cliente.svg" />
    } @else {
    <table class="global-tabla__elemento">
      <thead class="global-tabla__cabecera">
        <tr>
          <th>Nombre</th>
          <th>Correo</th>
          <th>Estado</th>
          <th>Rol</th>
          <th>Teléfono</th>
          <th>Saldo</th>
          <th>Último acceso</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody class="global-tabla__cuerpo">
        @for (usuario of usuariosPaginados(); track usuario.id) {
        <tr class="global-tabla__fila">
          <!-- Celda nombre como título centrado -->
          <td class="global-tabla__celda global-tabla__celda-principal global-tabla__celda--nombre-titulo">
            <p class="global-tabla__texto-titulo">{{ usuario.nombre }}</p>
          </td>
          <!-- Celda correo -->
          <td class="global-tabla__celda global-tabla__celda-info">
            <p>{{ usuario.email }}</p>
          </td>
          <!-- Celda estado -->
          <td class="global-tabla__celda global-tabla__celda-info global-tabla__celda--estado">
            <span class="global-badge" [class]="'global-badge--' + usuario.estado.toLowerCase()">
              {{ usuario.estado }}
            </span>
          </td>
          <!-- Celda rol -->
          <td class="global-tabla__celda global-tabla__celda-info">
            <p>{{ usuario.rol }}</p>
          </td>
          <!-- Celda teléfono -->
          <td class="global-tabla__celda global-tabla__celda-info global-tabla__celda--telefono">
            <p>{{ usuario.telefono || '—' }}</p>
          </td>
          <!-- Celda Saldo -->
          <td class="global-tabla__celda global-tabla__celda-info">
            <p>{{ usuario.saldo != null ? (usuario.saldo | number:'1.2-2') : '—' }}</p>
          </td>
          <!-- Celda último acceso -->
          <td class="global-tabla__celda global-tabla__celda-info">
            <p>{{ formatearFechaISO(usuario.ultimoAcceso) }}</p>
          </td>
          <!-- Celda acciones -->
          <td class="global-tabla__celda global-tabla__celda-acciones">
            <ul class="global-tabla__lista-acciones">
              <li>
                <button class="boton-secundario global-tabla__boton-accion" (click)="editarUsuario(usuario)"
                  [attr.aria-label]="'Editar usuario ' + usuario.nombre">
                  <img src="/iconos/ico-editar.svg" alt="" class="icono-boton icono-color-base">
                  <p>Editar</p>
                </button>
              </li>
              <li>
                <button class="boton-secundario global-tabla__boton-accion" (click)="eliminarUsuario(usuario.id)">
                  <img src="/iconos/ico-borrar.svg" alt="Icono borrar" class="icono-boton icono-color-base">
                  <p>Eliminar</p>
                </button>
              </li>
            </ul>
          </td>
        </tr>
        }
      </tbody>
    </table>
    }

    <!-- ===== PAGINACIÓN (solo si hay usuarios) ===== -->
    @if (usuariosPaginados().length > 0) {
    <div class="global-paginacion">
      <div class="global-paginacion__controles">
        <button class="global-paginacion__boton global-paginacion__boton--anterior" (click)="paginaAnterior()"
          [disabled]="paginaActual() === 1">
          <img src="/iconos/ico-flecha-izquierda-tabla.svg" alt="Icono flecha izquierda"
            class="icono-boton icono-color-base">
        </button>
        <div class="global-paginacion__numeros">
          @for (pagina of paginasAMostrar(); track pagina) {
          @if (pagina === -1) {
          <span class="global-paginacion__separador">...</span>
          } @else {
          <button class="global-paginacion__numero"
            [class.global-paginacion__numero--activa]="pagina === paginaActual()" (click)="irAPagina(pagina)"
            type="button">
            {{ pagina }}
          </button>
          }
          }
        </div>
        <button class="global-paginacion__boton global-paginacion__boton--siguiente" (click)="paginaSiguiente()"
          [disabled]="paginaActual() === totalPaginas()">
          <img src="/iconos/ico-flecha-derecha-tabla.svg" alt="Icono flecha derecha"
            class="icono-boton icono-color-base">
        </button>
      </div>
      <p class="global-paginacion__info">
        {{ (paginaActual() - 1) * usuariosPorPagina() + 1 }}-{{ Math.min(paginaActual() * usuariosPorPagina(),
        totalUsuarios()) }} de {{ totalUsuarios() }}
      </p>
    </div>
    }
  </section>
</div>

<!-- ===== MODAL CREAR/EDITAR USUARIO ===== -->
<app-modal [estaAbierto]="modalAbierto()" (cerrar)="cerrarModal()">
  <div class="global-modal">
    <div class="global-modal__cabecera">
      <h3 class="global-modal__titulo">{{ usuarioEnEdicion() ? 'Editar Usuario' : 'Crear Nuevo Usuario' }}</h3>
      <button type="button" class="global-modal__boton-cerrar" (click)="cerrarModal()" aria-label="Cerrar modal">
        <img src="/iconos/ico-cerrar.svg" alt="Cerrar" class="icono-boton icono-color-secundario">
      </button>
    </div>

    <form class="global-modal__contenido" autocomplete="off" (submit)="$event.preventDefault()">
      <!-- Foto de perfil (subida a Cloudinary) -->
      <div class="formulario-imagenes">
        <label class="global-formulario-campo__etiqueta">Foto de perfil</label>
        <div class="formulario-imagenes__contenedor-imagenes">
          <label for="input-foto-usuario"
            class="global-formulario-imagenes__contenedor global-formulario-imagenes__contenedor--clickeable"
            [class.usuarios-admin-modal__foto-deshabilitado]="subiendoFoto()">
            @if (subiendoFoto()) {
            <div class="usuarios-admin-modal__foto-cargando">
              <div class="usuarios-admin-modal__foto-spinner" aria-hidden="true"></div>
              <span>Subiendo...</span>
            </div>
            } @else if (formulario().fotoPerfil && formulario().fotoPerfil !== '/imagenes/usuarios/default.jpg') {
            <img [src]="formulario().fotoPerfil" alt="Foto de perfil" class="global-formulario-imagenes__preview"
              style="border-radius: 50%; width: 120px; height: 120px; object-fit: cover;">
            } @else {
            <img src="/iconos/ico-imagen.svg" alt="Icono imagen" class="icono-boton icono-color-secundario">
            <span class="global-formulario-imagenes__etiqueta1">Haz clic para subir foto de perfil</span>
            <span class="global-formulario-imagenes__etiqueta2">PNG, JPG hasta 5MB (Cloudinary)</span>
            }
          </label>
          <input type="file" id="input-foto-usuario" accept="image/*" (change)="manejarCambioImagen($event)"
            [disabled]="subiendoFoto()" style="display: none;">
        </div>
      </div>

      <!-- Nombre -->
      <div class="global-formulario-campo">
        <label class="global-formulario-campo__etiqueta">Nombre completo</label>
        <div class="global-formulario-campo__contenedor">
          <input type="text" class="global-formulario-campo__input" placeholder="Ej: Juan Pérez García"
            autocomplete="off" readonly (focus)="$event.target.removeAttribute('readonly')"
            [value]="formulario().nombre" (input)="actualizarNombre($event)">
        </div>
      </div>

      <!-- Email -->
      <div class="global-formulario-campo">
        <label class="global-formulario-campo__etiqueta">Correo electrónico</label>
        <div class="global-formulario-campo__contenedor">
          <input type="email" class="global-formulario-campo__input" placeholder="Ej: usuario@ejemplo.com"
            autocomplete="off" readonly (focus)="$event.target.removeAttribute('readonly')"
            [value]="formulario().email" (input)="actualizarEmail($event)">
        </div>
      </div>

      <!-- Teléfono -->
      <div class="global-formulario-campo">
        <label class="global-formulario-campo__etiqueta">Teléfono</label>
        <div class="global-formulario-campo__contenedor">
          <input type="tel" class="global-formulario-campo__input" placeholder="Ej: +51987654321"
            autocomplete="off" readonly (focus)="$event.target.removeAttribute('readonly')"
            [value]="formulario().telefono" (input)="actualizarTelefono($event)">
        </div>
      </div>

      @if (!usuarioEnEdicion()) {
      <!-- Contraseña (solo al crear) -->
      <div class="global-formulario-campo">
        <label class="global-formulario-campo__etiqueta">Contraseña</label>
        <div class="global-formulario-campo__contenedor">
          <input type="password" class="global-formulario-campo__input" placeholder="••••••••"
            autocomplete="new-password" readonly (focus)="$event.target.removeAttribute('readonly')"
            [value]="formulario().contrasena" (input)="actualizarContrasena($event)">
        </div>
      </div>
      }

      <!-- Estado: editable (Activo/Inactivo) -->
      <div class="global-formulario-campo">
        <label class="global-formulario-campo__etiqueta">Estado</label>
        <div class="global-formulario-opciones-radio">
          <label class="global-formulario-opciones-radio__opcion">
            <input type="radio" name="estado-usuario" value="Activo" [checked]="formulario().estado === 'Activo'"
              (change)="actualizarEstadoActivo()" class="global-radio__input">
            <span class="global-formulario-opciones-radio__label">Activo</span>
          </label>
          <label class="global-formulario-opciones-radio__opcion">
            <input type="radio" name="estado-usuario" value="Inactivo" [checked]="formulario().estado === 'Inactivo'"
              (change)="actualizarEstadoInactivo()" class="global-radio__input">
            <span class="global-formulario-opciones-radio__label">Inactivo</span>
          </label>
        </div>
      </div>

      <!-- Rol - dinámico desde API -->
      <div class="global-formulario-campo">
        <label class="global-formulario-campo__etiqueta">Rol</label>
        <div class="global-formulario-opciones-radio">
          @for (rol of roles(); track rol.id_rol) {
          <label class="global-formulario-opciones-radio__opcion">
            <input type="radio" name="rol-usuario" [value]="rol.nombre" [checked]="formulario().rol === rol.nombre"
              (change)="actualizarRol(rol.nombre)" class="global-radio__input">
            <span class="global-formulario-opciones-radio__label">{{ rol.nombre }}</span>
          </label>
          }
        </div>
      </div>

      <!-- Campos solo lectura (solo en edición) -->
      @if (usuarioEnEdicion()) {
      <div class="usuarios-admin-modal__solo-lectura">
        <h4 class="usuarios-admin-modal__solo-lectura-titulo">Información solo consulta</h4>
        <div class="usuarios-admin-modal__solo-lectura-grid">
          <div class="usuarios-admin-modal__campo-lectura">
            <span class="usuarios-admin-modal__campo-lectura-etiqueta">Login social</span>
            <span class="global-badge global-badge--{{ usuarioEnEdicion()!.socialLogin ? 'activo' : 'neutro' }} global-badge--grande">
              {{ usuarioEnEdicion()!.socialLogin ? 'Sí' : 'No' }}
            </span>
          </div>
          <div class="usuarios-admin-modal__campo-lectura">
            <span class="usuarios-admin-modal__campo-lectura-etiqueta">Nacionalidad</span>
            @if (obtenerPaisPorCodigo(usuarioEnEdicion()!.nacionalidad)) {
            <img [src]="obtenerPaisPorCodigo(usuarioEnEdicion()!.nacionalidad)!.bandera" alt="Bandera"
              class="usuarios-admin-modal__bandera">
            } @else {
            <span class="usuarios-admin-modal__campo-lectura-valor">—</span>
            }
          </div>
          <div class="usuarios-admin-modal__campo-lectura">
            <span class="usuarios-admin-modal__campo-lectura-etiqueta">Saldo</span>
            <span class="usuarios-admin-modal__campo-lectura-valor">{{ usuarioEnEdicion()!.saldo != null ? (usuarioEnEdicion()!.saldo | number:'1.2-2') : '—' }}</span>
          </div>
          <div class="usuarios-admin-modal__campo-lectura">
            <span class="usuarios-admin-modal__campo-lectura-etiqueta">Último acceso</span>
            <span class="usuarios-admin-modal__campo-lectura-valor">{{ formatearFechaISO(usuarioEnEdicion()!.ultimoAcceso) }}</span>
          </div>
          <div class="usuarios-admin-modal__campo-lectura">
            <span class="usuarios-admin-modal__campo-lectura-etiqueta">Fecha de creación</span>
            <span class="usuarios-admin-modal__campo-lectura-valor">{{ formatearFechaISO(usuarioEnEdicion()!.fechaCreacion) }}</span>
          </div>
          <div class="usuarios-admin-modal__campo-lectura">
            <span class="usuarios-admin-modal__campo-lectura-etiqueta">Última actualización</span>
            <span class="usuarios-admin-modal__campo-lectura-valor">{{ formatearFechaISO(usuarioEnEdicion()!.fechaActualizacion) }}</span>
          </div>
        </div>
      </div>
      }
    </form>

    <div class="global-modal__acciones">
      <button type="button" class="boton-secundario" (click)="cerrarModal()">
        <p>Cancelar</p>
      </button>
      <button type="button" class="boton-primario" (click)="guardarUsuario()">
        <p>{{ usuarioEnEdicion() ? 'Guardar Cambios' : 'Crear Usuario' }}</p>
      </button>
    </div>
  </div>
</app-modal>