<div class="contenedor-metodos-pago" (click)="cerrarTodosLosDropdowns()">
  <section class="titulo-opciones-contenedor">
    <div class="titulo-contenedor">
      <img src="/iconos/ico-configuracion.svg" alt="Icono métodos de pago" class="icono-boton icono-color-base">
      <h3>Métodos de Pago</h3>
    </div>
    <div class="opciones-contenedor">
      <button type="button" class="boton-primario" (click)="abrirModalCrear()">
        Crear
      </button>
    </div>
  </section>

  <section class="global-tabla">
    @if (cargando()) {
    <app-bloque-estado-tabla estado="cargando" mensajeCarga="Cargando métodos de pago..." />
    } @else if (errorAlCargar()) {
    <app-bloque-estado-tabla estado="vacio" tituloVacio="Error al cargar"
      textoVacio="No se pudieron cargar los métodos de pago. Revisa tu conexión y vuelve a intentar."
      iconoVacio="/iconos/ico-configuracion.svg" />
    <div class="metodos-pago-reintentar">
      <button type="button" class="boton-secundario" (click)="cargarMetodos()">Reintentar</button>
    </div>
    } @else if (metodosPago().length === 0) {
    <app-bloque-estado-tabla estado="vacio" tituloVacio="Aún no hay métodos de pago"
      textoVacio="Crea tu primer método de pago para que los clientes puedan elegir cómo pagar."
      iconoVacio="/iconos/ico-configuracion.svg" />
    } @else {
    <table class="global-tabla__elemento">
      <thead class="global-tabla__cabecera">
        <tr>
          <th>Método</th>
          <th>Información</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody class="global-tabla__cuerpo">
        @for (metodo of metodosPago(); track metodo.id_metodo_pago) {
        <tr class="global-tabla__fila">
          <td class="global-tabla__celda global-tabla__celda-logo">
            <img [src]="metodo.logo" [alt]="metodo.nombre" class="metodo-pago-logo" />
          </td>
          <td class="global-tabla__celda global-tabla__celda--informacion">
            <div class="metodo-pago-info">
              <p class="metodo-pago-info__nombre">{{ metodo.nombre }}</p>
              <p class="metodo-pago-info__descripcion">{{ metodo.descripcion }}</p>
            </div>
          </td>
          <td class="global-tabla__celda global-tabla__celda-acciones">
            <ul class="global-tabla__lista-acciones">
              <li>
                <button class="boton-secundario global-tabla__boton-accion" (click)="abrirModalEdicion(metodo)">
                  <img src="/iconos/ico-editar.svg" alt="Editar" class="icono-boton icono-color-base" />
                  <p>Editar</p>
                </button>
              </li>
            </ul>
          </td>
        </tr>
        }
      </tbody>
    </table>
    }
  </section>
</div>

<!-- ===== MODAL: CREAR / EDITAR MÉTODO DE PAGO ===== -->
<app-modal [estaAbierto]="modalAbierto()" (cerrar)="cerrarModal()">
  <div class="global-modal">

    <div class="global-modal__cabecera">
      <h3 class="global-modal__titulo">
        {{ modoCreacion() ? 'Nuevo método de pago' : 'Editar ' + (metodoEnEdicion()?.nombre || '') }}
      </h3>
      <button type="button" class="global-modal__boton-cerrar" (click)="cerrarModal()" aria-label="Cerrar modal">
        <img src="/iconos/ico-cerrar.svg" alt="Cerrar" class="icono-boton icono-color-base">
      </button>
    </div>

    <div class="global-modal__contenido global-modal__contenido--grid">

      <div class="formulario-grupo">
        <label class="formulario-etiqueta">Nombre <span class="formulario-obligatorio">*</span></label>
        <input type="text" class="formulario-input" placeholder="Ej: Yape, Plin, Transferencia"
          [value]="metodoEnEdicion()?.nombre" (input)="actualizarCampo('nombre', $any($event.target).value)" />
      </div>

      <div class="formulario-grupo">
        <label class="formulario-etiqueta">Descripción</label>
        <input type="text" class="formulario-input" placeholder="Ej: Paga con Yape escaneando el QR"
          [value]="metodoEnEdicion()?.descripcion"
          (input)="actualizarCampo('descripcion', $any($event.target).value)" />
      </div>

      <div class="formulario-grupo">
        <label class="formulario-etiqueta">Logo del método</label>
        <div class="metodo-pago-subida">
          <input type="file" accept="image/*" (change)="subirLogo($event)" [disabled]="subiendoLogo()"
            class="metodo-pago-subida__input" #inputLogo>
          <button type="button" class="boton-secundario metodo-pago-subida__boton" (click)="inputLogo.click()"
            [disabled]="subiendoLogo()">
            {{ subiendoLogo() ? 'Subiendo...' : (metodoEnEdicion()?.logo ? 'Cambiar logo' : 'Subir logo') }}
          </button>
        </div>
      </div>

      <div class="formulario-grupo">
        <label class="formulario-etiqueta">Tipo de QR</label>
        <select class="formulario-input" [value]="metodoEnEdicion()?.qrTipo ?? ''"
          (change)="actualizarCampo('qrTipo', $any($event.target).value === '' ? '' : $any($event.target).value)">
          <option value="">Sin QR</option>
          <option value="estatico">Estático (imagen fija)</option>
          <option value="dinamico">Dinámico</option>
        </select>
        <p class="formulario-ayuda">Si es estático, debes subir la imagen del QR más abajo.</p>
      </div>

      @if (metodoEnEdicion()?.qrTipo === 'estatico') {
      <div class="formulario-grupo">
        <label class="formulario-etiqueta">Imagen del QR <span class="formulario-obligatorio">*</span></label>
        <div class="metodo-pago-subida">
          <input type="file" accept="image/*" (change)="subirQrImagen($event)" [disabled]="subiendoQr()"
            class="metodo-pago-subida__input" #inputQr>
          <button type="button" class="boton-secundario metodo-pago-subida__boton" (click)="inputQr.click()"
            [disabled]="subiendoQr()">
            {{ subiendoQr() ? 'Subiendo...' : (metodoEnEdicion()?.qrImagen ? 'Cambiar imagen QR' : 'Subir imagen del
            QR') }}
          </button>
        </div>
      </div>
      }

      <!-- CAMPO: API KEY -->
      <div class="formulario-grupo">
        <label class="formulario-etiqueta">API Key</label>
        <div class="formulario-input-contenedor">
          <input [type]="mostrarApiKey() ? 'text' : 'password'" class="formulario-input"
            placeholder="Ingresa tu API Key" [value]="metodoEnEdicion()?.apiKey"
            (input)="actualizarCampo('apiKey', $any($event.target).value)" />
          <button type="button" class="formulario-boton-icono" (click)="alternarVisibilidadApiKey()">
            <img [src]="mostrarApiKey() ? '/iconos/ico-ojo-abierto.svg' : '/iconos/ico-ojo-cerrado.svg'"
              alt="Mostrar/Ocultar" class="icono-boton icono-color-base" />
          </button>
        </div>
      </div>

      <!-- CAMPO: SECRET KEY -->
      <div class="formulario-grupo">
        <label class="formulario-etiqueta">Secret Key</label>
        <div class="formulario-input-contenedor">
          <input [type]="mostrarSecretKey() ? 'text' : 'password'" class="formulario-input"
            placeholder="Ingresa tu Secret Key" [value]="metodoEnEdicion()?.secretKey"
            (input)="actualizarCampo('secretKey', $any($event.target).value)" />
          <button type="button" class="formulario-boton-icono" (click)="alternarVisibilidadSecretKey()">
            <img [src]="mostrarSecretKey() ? '/iconos/ico-ojo-abierto.svg' : '/iconos/ico-ojo-cerrado.svg'"
              alt="Mostrar/Ocultar" class="icono-boton icono-color-base" />
          </button>
        </div>
      </div>

      <div class="formulario-grupo campo-completo">
        <label class="formulario-etiqueta">Tasa de cambio (opcional)</label>
        <input type="number" step="0.01" class="formulario-input" placeholder="Ej: 3.75 (USD a moneda local)"
          [value]="metodoEnEdicion()?.tipo_cambio ?? metodoEnEdicion()?.tasaCambio"
          (input)="actualizarCampo('tasaCambio', +$any($event.target).value)" />
        <p class="formulario-ayuda">Solo si aplica conversión de moneda para este método.</p>
      </div>
    </div>

    <div class="global-modal__acciones">
      <button type="button" class="boton-secundario" (click)="cerrarModal()" [disabled]="guardando()">
        Cancelar
      </button>
      <button type="button" class="boton-primario" (click)="guardarCambios()" [disabled]="guardando()">
        {{ guardando() ? 'Guardando...' : (modoCreacion() ? 'Crear método de pago' : 'Guardar cambios') }}
      </button>
    </div>
  </div>
</app-modal>