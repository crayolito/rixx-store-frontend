<div class="lista-codigos-contenedor">
  <!-- ===== SECCIÓN: TITULO Y OPCIONES ===== -->
  <section class="titulo-opciones-contenedor">
    <div class="titulo-contenedor">
      <img src="/iconos/ico-codigo.svg" alt="Icono códigos" class="icono-boton icono-color-base">
      <h3>Códigos</h3>
    </div>
    <div class="opciones-contenedor">
      <button class="boton-secundario" (click)="alternarFiltros()">
        <p>{{ filtrosVisibles() ? 'Ocultar Filtros' : 'Mostrar Filtros' }}</p>
      </button>
      <button class="boton-primario" (click)="abrirModalAgregar()">
        <p>Agregar código</p>
      </button>
    </div>
  </section>

  <!-- ===== SECCIÓN: FILTROS DE ESTADO CON BADGES DE COLORES ===== -->
  @if (filtrosVisibles()) {
  <section class="filtros-estado-badges">
    <div class="filtros-estado-badges__lista">
      @for (estado of estadosFiltro; track estado.valor) {
      <button class="filtros-estado-badges__item filtros-estado-badges__item--{{estado.color}}"
        [class.filtros-estado-badges__item--activo]="estadoActivoFiltro() === estado.valor"
        (click)="filtrarPorEstado(estado.valor)" type="button">
        <span class="filtros-estado-badges__nombre">{{ estado.nombre }}</span>
        <span class="filtros-estado-badges__contador">{{ contadorPorEstado(estado.valor) }}</span>
      </button>
      }
    </div>
  </section>
  }

  <!-- ===== SECCIÓN: FILTROS AVANZADOS ===== -->
  @if (filtrosVisibles()) {
  <section class="global-filtros" (click)="$event.stopPropagation()">
    <!-- Buscador de texto: código, producto, precio y cliente -->
    <div class="global-filtros__item">
      <p class="global-filtros__titulo">Buscador</p>
      <div class="global-filtros__busqueda">
        <img src="/iconos/ico-busqueda.svg" alt="Icono busqueda" class="icono-boton icono-color-base">
        <input type="text" placeholder="Buscar por código, producto, precio o cliente..." class="global-filtros__input" [value]="textoBusqueda()"
          (input)="textoBusqueda.set($any($event.target).value); paginaActual.set(1)">
      </div>
    </div>

    <!-- Filtro Fecha Creación -->
    <div class="global-filtros__item">
      <p class="global-filtros__titulo">Fecha Creación</p>
      <div class="global-filtros__busqueda">
        <input type="date" class="global-filtros__input" [value]="fechaCreacion()"
          (input)="fechaCreacion.set($any($event.target).value); paginaActual.set(1)">
      </div>
    </div>

    <!-- Filtro Fecha Expiración -->
    <div class="global-filtros__item">
      <p class="global-filtros__titulo">Fecha Expiración</p>
      <div class="global-filtros__busqueda">
        <input type="date" class="global-filtros__input" [value]="fechaExpiracion()"
          (input)="fechaExpiracion.set($any($event.target).value); paginaActual.set(1)">
      </div>
    </div>

    <!-- Botón Limpiar -->
    <div class="global-filtros__item">
      <button class="boton-secundario global-filtros__boton-icono" (click)="limpiarFiltros()" type="button">
        <img src="/iconos/ico-limpiar.svg" alt="Icono limpiar" class="icono-boton icono-color-base">
      </button>
    </div>
  </section>
  }

  <!-- ===== SECCIÓN: TABLA DE CÓDIGOS ===== -->
  <section class="global-tabla">
    @if (estaCargando()) {
    <app-bloque-estado-tabla estado="cargando" mensajeCarga="Cargando códigos..." />
    } @else if (errorAlCargar()) {
    <app-bloque-estado-tabla estado="vacio" tituloVacio="Error al cargar"
      textoVacio="No se pudieron cargar los códigos. Intenta de nuevo." iconoVacio="/iconos/ico-codigo.svg" />
    } @else if (codigosPaginados().length === 0) {
    <app-bloque-estado-tabla estado="vacio" tituloVacio="No se encontraron códigos"
      textoVacio="Ajusta los filtros o agrega un código." iconoVacio="/iconos/ico-codigo.svg" />
    } @else {
    <table class="global-tabla__elemento">
      <thead class="global-tabla__cabecera">
        <tr>
          <th>Código</th>
          <th>Producto / Precio</th>
          <th>Cliente</th>
          <th>Estado</th>
          <th>Fecha Creación</th>
          <th>Fecha Exp.</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody class="global-tabla__cuerpo">
        @for (codigo of codigosPaginados(); track codigo.id_codigo) {
        <tr class="global-tabla__fila">
          <td class="global-tabla__celda global-tabla__celda-info global-tabla__celda--codigo">
            <p [title]="codigo.codigo">{{ truncarTexto(codigo.codigo, 30) }}</p>
          </td>
          <td class="global-tabla__celda global-tabla__celda-info global-tabla__celda--producto-precio">
            <div class="celda-producto-precio">
              <p class="celda-producto-precio__nombre" [title]="codigo.nombreProducto">
                {{ truncarTexto(codigo.nombreProducto, 30) }}
              </p>
              <p class="celda-producto-precio__precio">{{ codigo.nombrePrecio }}</p>
            </div>
          </td>
          <td class="global-tabla__celda global-tabla__celda-info global-tabla__celda--cliente">
            <p [title]="codigo.correoCliente ?? ''">{{ truncarTexto(codigo.correoCliente ?? '—', 25) }}</p>
          </td>
          <td class="global-tabla__celda global-tabla__celda-info global-tabla__celda--estado">
            <span class="global-badge" [class]="'global-badge--' + codigo.estado">
              {{ codigo.estado }}
            </span>
          </td>
          <td class="global-tabla__celda global-tabla__celda-info global-tabla__celda--fecha-creacion">
            <p>{{ formatearFechaCreacion(codigo.fechaCreacion) }}</p>
          </td>
          <td class="global-tabla__celda global-tabla__celda-info">
            <p>{{ formatearFechaExpiracion(codigo.fechaExpiracion) }}</p>
          </td>
          <td class="global-tabla__celda global-tabla__celda-acciones">
            <button class="boton-secundario global-tabla__boton-accion" (click)="eliminarCodigo(codigo.id_codigo)">
              <img src="/iconos/ico-borrar.svg" alt="Icono borrar" class="icono-boton icono-color-base">
              <p>Eliminar</p>
            </button>
          </td>
        </tr>
        }
      </tbody>
    </table>
    }

    <!-- ===== PAGINACIÓN ===== -->
    <div class="global-paginacion">
      <div class="global-paginacion__controles">
        <button class="global-paginacion__boton global-paginacion__boton--anterior" (click)="paginaAnterior()"
          [disabled]="paginaActual() === 1">
          <img src="/iconos/ico-flecha-izquierda-tabla.svg" alt="Icono flecha izquierda"
            class="icono-boton icono-color-base">
        </button>
        <div class="global-paginacion__numeros">
          @for (pagina of paginasAMostrar(); track pagina) {
          @if (pagina === -1) {
          <span class="global-paginacion__separador">...</span>
          } @else {
          <button class="global-paginacion__numero"
            [class.global-paginacion__numero--activa]="pagina === paginaActual()" (click)="irAPagina(pagina)"
            type="button">
            {{ pagina }}
          </button>
          }
          }
        </div>
        <button class="global-paginacion__boton global-paginacion__boton--siguiente" (click)="paginaSiguiente()"
          [disabled]="paginaActual() === totalPaginas()">
          <img src="/iconos/ico-flecha-derecha-tabla.svg" alt="Icono flecha derecha"
            class="icono-boton icono-color-base">
        </button>
      </div>
      <p class="global-paginacion__info">
        {{ (paginaActual() - 1) * codigosPorPagina() + 1 }}-{{ Math.min(paginaActual() * codigosPorPagina(),
        totalCodigos()) }} de {{ totalCodigos() }}
      </p>
    </div>
  </section>
</div>

<!-- ===== MODAL: AGREGAR CÓDIGO (una columna, sin editar código) ===== -->
<app-modal [estaAbierto]="modalAgregarAbierto()" (cerrar)="cerrarModalAgregar()">
  <div class="global-modal global-modal--ancho" (click)="cerrarBusquedaProducto()">
    <div class="global-modal__cabecera">
      <h3 class="global-modal__titulo">Agregar Códigos</h3>
      <button class="global-modal__boton-cerrar" (click)="cerrarModalAgregar()" type="button">
        <img src="/iconos/ico-cerrar.svg" alt="Cerrar" class="icono-boton icono-color-secundario">
      </button>
    </div>

    <div class="global-modal__contenido codigos-modal--una-columna">
      <!-- 1) Producto: primero se escoge el producto con buscador -->
      <div class="global-formulario-campo codigos-modal__busqueda-producto" (click)="$event.stopPropagation()">
        <label class="global-formulario-campo__etiqueta">Producto *</label>
        <div class="global-formulario-campo__contenedor global-formulario-campo__contenedor--busqueda">
          <img src="/iconos/ico-busqueda.svg" alt="Buscar" class="icono-boton icono-color-base">
          <input type="text" class="global-formulario-campo__input" placeholder="Buscar producto..."
            [value]="desplegarBusquedaProducto() ? busquedaProductoModal() : textoProductoSeleccionado()"
            (input)="busquedaProductoModal.set($any($event.target).value); desplegarBusquedaProducto.set(true)"
            (focus)="desplegarBusquedaProducto.set(true)">
          @if (textoProductoSeleccionado() && !busquedaProductoModal()) {
          <button type="button" class="codigos-modal__limpiar-seleccion"
            (click)="limpiarProductoSeleccionado(); $event.stopPropagation()">
            <img src="/iconos/ico-cerrar.svg" alt="Quitar" class="icono-boton icono-color-base">
          </button>
          }
        </div>
        @if (desplegarBusquedaProducto()) {
        <div class="codigos-modal__opciones-lista">
          @if (productosFiltradosModal().length > 0) {
          @for (producto of productosFiltradosModal(); track producto.id) {
          <button type="button" class="codigos-modal__opcion" (click)="seleccionarProductoModal(producto.id)">
            <span class="codigos-modal__opcion-producto">{{ producto.nombre }}</span>
          </button>
          }
          } @else {
          <div class="codigos-modal__sin-resultados">
            <p>No se encontraron productos</p>
          </div>
          }
        </div>
        }
        <label class="global-formulario-campo__ayuda">
          Busca y selecciona el producto. Después elige el precio.
        </label>
      </div>

      <!-- 2) Precio: se habilita y muestra solo cuando hay producto seleccionado -->
      <div class="global-formulario-campo" [class.codigos-modal__campo-deshabilitado]="!precioSelectHabilitado()">
        <label class="global-formulario-campo__etiqueta">Precio del producto *</label>
        <div class="global-formulario-campo__contenedor">
          <select class="global-formulario-campo__input" [disabled]="!precioSelectHabilitado() || cargandoPreciosProducto()"
            [value]="precioSeleccionado()" (change)="seleccionarPrecioModal($any($event.target).value)">
            @if (cargandoPreciosProducto()) {
            <option value="">Cargando precios...</option>
            } @else if (!precioSelectHabilitado()) {
            <option value="">Primero selecciona un producto</option>
            } @else {
            <option value="">Seleccionar precio...</option>
            @for (precio of preciosDisponibles(); track precio.id) {
            <option [value]="precio.id">{{ precio.nombre }} — {{ precio.precio }}</option>
            }
            }
          </select>
        </div>
        @if (precioSelectHabilitado()) {
        <label class="global-formulario-campo__ayuda">
          Elige el precio del producto seleccionado.
        </label>
        }
      </div>

      <!-- Códigos -->
      <div class="global-formulario-campo">
        <label class="global-formulario-campo__etiqueta">Códigos *</label>
        <div class="global-formulario-campo__contenedor global-formulario-campo__contenedor--textarea">
          <textarea class="global-formulario-campo__textarea textarea-codigo" rows="6"
            placeholder="Un código por línea.&#10;&#10;Ejemplo:&#10;ABC123-XYZ&#10;DEF456-UVW"
            [value]="textoCodigosModal()" (input)="textoCodigosModal.set($any($event.target).value)"></textarea>
        </div>
        <label class="global-formulario-campo__ayuda">
          Un código por línea.
        </label>
      </div>

      <!-- Fecha de expiración (opcional, igual que antes) -->
      <div class="global-formulario-campo">
        <div class="codigos-modal__fila-checkbox">
          <div class="global-checkbox">
            <input type="checkbox" id="sin-fecha-expiracion" [checked]="sinFechaExpiracion()"
              (change)="alternarSinFechaExpiracion()" class="global-checkbox__input" />
            <label for="sin-fecha-expiracion" class="global-checkbox__contenido">
              <p class="global-checkbox__titulo">Sin fecha de expiración</p>
            </label>
          </div>
        </div>
        <div class="global-formulario-campo__contenedor">
          <input type="date" class="global-formulario-campo__input" [disabled]="sinFechaExpiracion()"
            [value]="fechaExpiracionCodigo()" (input)="fechaExpiracionCodigo.set($any($event.target).value)">
        </div>
      </div>
    </div>

    <div class="global-modal__acciones">
      <button class="boton-secundario" (click)="cerrarModalAgregar()" type="button">
        Cancelar
      </button>
      <button class="boton-primario" type="button" (click)="guardarCodigos()" [disabled]="guardando()">
        {{ guardando() ? 'Guardando...' : 'Guardar códigos' }}
      </button>
    </div>
  </div>
</app-modal>