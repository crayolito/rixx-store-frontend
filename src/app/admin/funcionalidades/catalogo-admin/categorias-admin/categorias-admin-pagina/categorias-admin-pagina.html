<div class="contenedor-flex">
  <!-- ===== SECCIÓN: TITULO Y OPCIONES ===== -->
  <section class="titulo-opciones-contenedor">
    <div class="titulo-contenedor">
      <img src="/iconos/ico-categorias.svg" alt="Icono categorías" class="icono-boton icono-color-base">
      <h3>Categorías</h3>
    </div>
    <div class="opciones-contenedor">
      <button class="boton-secundario" (click)="alternarFiltros()" type="button">
        <p>{{ filtrosVisibles() ? 'Ocultar Filtros' : 'Mostrar Filtros' }}</p>
      </button>
      <button class="boton-primario" (click)="abrirModalAgregar()" type="button">
        <p>Agregar Categoría</p>
      </button>
    </div>
  </section>

  <!-- ===== SECCIÓN: FILTROS (solo nombre de categoría) ===== -->
  @if (filtrosVisibles()) {
  <section class="global-filtros">
    <div class="global-filtros__item">
      <p class="global-filtros__titulo">Nombre de la categoría</p>
      <div class="global-filtros__busqueda">
        <img src="/iconos/ico-busqueda.svg" alt="Icono busqueda" class="icono-boton icono-color-base">
        <input type="text" placeholder="Buscar por nombre..." class="global-filtros__input" [value]="textoBusqueda()"
          (input)="actualizarBusqueda($event)">
      </div>
    </div>
    <div class="global-filtros__item">
      <button class="boton-secundario global-filtros__boton-icono" (click)="limpiarFiltros()" type="button"
        aria-label="Limpiar filtros">
        <img src="/iconos/ico-limpiar.svg" alt="Icono limpiar filtros" class="icono-boton icono-color-base">
      </button>
    </div>
  </section>
  }

  <!-- ===== SECCIÓN: TABLA DE CATEGORÍAS ===== -->
  <section class="global-tabla">
    @if (estaCargando()) {
    <app-bloque-estado-tabla estado="cargando" mensajeCarga="Cargando categorías..." />
    } @else if (categoriasPaginadas().length === 0) {
    <app-bloque-estado-tabla estado="vacio" tituloVacio="No se encontraron categorías"
      textoVacio="Ajusta el filtro o agrega una categoría." iconoVacio="/iconos/ico-categorias.svg" />
    } @else {
    <table class="global-tabla__elemento">
      <thead class="global-tabla__cabecera">
        <tr>
          <th>Nombre</th>
          <th>Genera Códigos</th>
          <th>Productos</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody class="global-tabla__cuerpo">
        @for (categoria of categoriasPaginadas(); track categoria.id) {
        <tr class="global-tabla__fila">
          <td class="global-tabla__celda global-tabla__celda-info">
            <p>{{ categoria.nombre }}</p>
          </td>
          <td class="global-tabla__celda global-tabla__celda-info">
            <p>{{ categoria.generaCodigo ? 'Sí' : 'No' }}</p>
          </td>
          <td class="global-tabla__celda global-tabla__celda-info">
            <p>{{ cantidadProductos(categoria) }}</p>
          </td>
          <td class="global-tabla__celda global-tabla__celda-acciones">
            <ul class="global-tabla__lista-acciones">
              <li>
                <button class="boton-secundario global-tabla__boton-accion" (click)="abrirModalEditar(categoria)"
                  [attr.aria-label]="'Editar categoría ' + categoria.nombre">
                  <img src="/iconos/ico-editar.svg" alt="" class="icono-boton icono-color-base">
                  <p>Editar</p>
                </button>
              </li>
              <li>
                <button class="boton-secundario global-tabla__boton-accion" (click)="eliminarCategoria(categoria.id)"
                  [attr.aria-label]="'Eliminar categoría ' + categoria.nombre">
                  <img src="/iconos/ico-borrar.svg" alt="Icono borrar" class="icono-boton icono-color-base">
                  <p>Eliminar</p>
                </button>
              </li>
            </ul>
          </td>
        </tr>
        }
      </tbody>
    </table>
    }

    <!-- ===== PAGINACIÓN (solo si hay categorías) ===== -->
    @if (categoriasPaginadas().length > 0) {
    <div class="global-paginacion">
      <div class="global-paginacion__controles">
        <button class="global-paginacion__boton global-paginacion__boton--anterior" (click)="paginaAnterior()"
          [disabled]="paginaActual() === 1">
          <img src="/iconos/ico-flecha-izquierda-tabla.svg" alt="Icono flecha izquierda"
            class="icono-boton icono-color-base">
        </button>
        <div class="global-paginacion__numeros">
          @for (pagina of paginasAMostrar(); track pagina) {
          @if (pagina === -1) {
          <span class="global-paginacion__separador">...</span>
          } @else {
          <button class="global-paginacion__numero"
            [class.global-paginacion__numero--activa]="pagina === paginaActual()" (click)="irAPagina(pagina)"
            type="button">
            {{ pagina }}
          </button>
          }
          }
        </div>
        <button class="global-paginacion__boton global-paginacion__boton--siguiente" (click)="paginaSiguiente()"
          [disabled]="paginaActual() === totalPaginas()">
          <img src="/iconos/ico-flecha-derecha-tabla.svg" alt="Icono flecha derecha"
            class="icono-boton icono-color-base">
        </button>
      </div>
      <p class="global-paginacion__info">
        {{ (paginaActual() - 1) * categoriasPorPagina() + 1 }}-{{ Math.min(paginaActual() * categoriasPorPagina(),
        totalCategorias()) }} de {{ totalCategorias() }}
      </p>
    </div>
    }
  </section>
</div>

<!-- Modal: Agregar/Editar Categoría -->
<app-modal [estaAbierto]="modalTipoCampoAbierto()" (cerrar)="cerrarModalTipoCampo()">
  <div class="global-modal">
    <div class="global-modal__cabecera">
      <h3 class="global-modal__titulo">{{ categoriaEditando() ? 'Editar Categoría' : 'Agregar Categoría' }}</h3>
      <button type="button" class="global-modal__boton-cerrar" (click)="cerrarModalTipoCampo()"
        aria-label="Cerrar modal">
        <img src="/iconos/ico-cerrar.svg" alt="Cerrar" class="icono-boton icono-color-secundario">
      </button>
    </div>
    <div class="global-modal__contenido">
      <div class="global-formulario-campo">
        <label class="global-formulario-campo__etiqueta">Nombre</label>
        <div class="global-formulario-campo__contenedor">
          <input type="text" class="global-formulario-campo__input" placeholder="Ej: Electrónica"
            [value]="nombreCategoria()" (input)="nombreCategoria.set($any($event.target).value)">
        </div>
      </div>
      <div class="global-formulario-campo">
        <div class="global-checkbox">
          <input type="checkbox" id="genera-codigo-categoria" class="global-checkbox__input"
            [checked]="generaCodigoCategoria()" (change)="generaCodigoCategoria.set($any($event.target).checked)">
          <label for="genera-codigo-categoria" class="global-checkbox__contenido">
            <p class="global-checkbox__titulo">Permitir generar códigos</p>
          </label>
        </div>
      </div>
    </div>
    <div class="global-modal__acciones">
      <button type="button" class="boton-secundario" (click)="cerrarModalTipoCampo()">
        <p>Cerrar</p>
      </button>
      <button type="button" class="boton-primario" (click)="guardarCategoria()" [disabled]="guardando()">
        <p>{{ guardando() ? 'Guardando...' : 'Guardar' }}</p>
      </button>
    </div>
  </div>
</app-modal>