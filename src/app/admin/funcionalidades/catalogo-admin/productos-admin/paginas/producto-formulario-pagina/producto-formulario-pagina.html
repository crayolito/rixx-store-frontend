<div class="contenedor-grid">
  <div class="contenedor-base">
    <!-- Sección: Título y Opciones -->
    <section class="seccion-titulo">
      <div class="titulo-contenedor">
        <img src="/iconos/ico-producto.svg" alt="Icono productos" class="icono-boton icono-color-base">
        <h3>Agregar Producto</h3>
      </div>
      <div class="opciones-contenedor">
        <button type="button" class="boton-secundario" (click)="volver()">
          <p>Volver</p>
        </button>
        <button type="button" class="boton-primario" (click)="guardar()">
          <p>Guardar</p>
        </button>
      </div>
    </section>

    <!-- Sección: Información Básica -->
    <section class="seccion-base">
      <div class="titulo-contenedor">
        <h3>Información Básica</h3>
      </div>
      <div class="global-formulario-campo">
        <label class="global-formulario-campo__etiqueta">Título</label>
        <div class="global-formulario-campo__contenedor">
          <input type="text" class="global-formulario-campo__input" placeholder="Ingrese el título" [value]="titulo()"
            (input)="titulo.set($any($event.target).value)">
        </div>
      </div>
      <div class="formulario-imagenes">
        <label class="global-formulario-campo__etiqueta">Multimedia</label>
        <div class="global-formulario-imagenes__contenedor-imagenes">
          <div class="global-formulario-imagenes__contenedor">
            <img src="/iconos/ico-imagen.svg" alt="Icono imagen" class="icono-boton icono-color-secundario">
            <label class="global-formulario-imagenes__etiqueta1">Haz clic para subir una imagen (Desktop)</label>
            <label class="global-formulario-imagenes__etiqueta2">PNG, JPG, GIF hasta 10MB</label>
          </div>
          <div class="global-formulario-imagenes__contenedor">
            <img src="/iconos/ico-imagen.svg" alt="Icono imagen" class="icono-boton icono-color-secundario">
            <label class="global-formulario-imagenes__etiqueta1">Haz clic para subir una imagen (Mobile)</label>
            <label class="global-formulario-imagenes__etiqueta2">PNG, JPG, GIF hasta 10MB</label>
          </div>
        </div>
      </div>
      <div class="formulario-multiple-opcion">
        <div class="formulario-categorias__contenedor">
          <label class="global-formulario-campo__etiqueta">Categorías</label>
          @if (categoriasSeleccionadas().length > 0) {
          <div class="formulario-categorias__seleccionadas">
            @for (categoria of categoriasSeleccionadas(); track categoria.id) {
            <div class="categoria__seleccionada">
              <p>{{ categoria.nombre }}</p>
              <button type="button" class="categoria__boton-eliminar" (click)="eliminarCategoria(categoria)"
                aria-label="Eliminar categoría">
                <img src="/iconos/ico-cerrar.svg" alt="Eliminar" class="icono-boton icono-color-secundario">
              </button>
            </div>
            }
          </div>
          }
          <div class="global-formulario-campo__contenedor global-formulario-campo__contenedor--clickeable"
            (click)="mostrarOpcionesCategorias.set(!mostrarOpcionesCategorias())">
            <p>{{ categoriasSeleccionadas().length }} categoría(s) seleccionada(s)</p>
            <img src="/iconos/ico-expandir-todo.svg" alt="Icono expandir" class="icono-boton icono-color-secundario"
              [class.rotado]="mostrarOpcionesCategorias()">
          </div>
          @if (categoriasSeleccionadas().length === 0) {
          <label class="formulario-etiqueta__anuncio-alerta">Debes seleccionar al menos una categoría</label>
          }
          @if (mostrarOpcionesCategorias()) {
          <div class="formulario-categorias__opciones">
            <div class="formulario-categorias__busqueda">
              <div class="global-formulario-campo__contenedor global-formulario-campo__contenedor--busqueda">
                <img src="/iconos/ico-busqueda.svg" alt="Buscar" class="icono-boton icono-color-secundario">
                <input type="text" class="global-formulario-campo__inputformulario-campo__input--busqueda"
                  placeholder="Buscar categoría..." [value]="buscarCategoria()"
                  (input)="buscarCategoria.set($any($event.target).value)" (click)="$event.stopPropagation()">
              </div>
            </div>
            <div class="formulario-categorias__opciones-lista">
              @if (hayResultadosBusqueda()) {
              @for (categoria of categoriasFiltradas(); track categoria.id) {
              <div class="categoria__opcion" [class.categoria__opcion--seleccionada]="categoria.seleccionada"
                (click)="toggleCategoria(categoria)">
                <p>{{ categoria.nombre }}</p>
                @if (categoria.seleccionada) {
                <img src="/iconos/ico-check.svg" alt="Seleccionada" class="icono-boton icono-color-primario">
                }
              </div>
              }
              } @else {
              <div class="categoria__sin-resultados">
                <p>No se encontraron categorías</p>
              </div>
              }
            </div>
          </div>
          }
        </div>
      </div>
    </section>

    <!-- Sección: Campos Adicionales -->
    <section class="seccion-base">
      <div class="titulo-contenedor">
        <h3>Campos Adicionales</h3>
        <!-- <p class="titulo-contenedor__descripcion">Define campos personalizados que el cliente deberá completar al
          comprar
          este producto (ej: ID de juego, zona, servidor, etc.)</p> -->
        <div class="opciones-contenedor">
          @if (esProductoManual()) {
          <button type="button" class="boton-primario" (click)="abrirModalAgregarCampo()">
            <p>Agregar campo</p>
          </button>
          }
        </div>
      </div>


      <div class="global-checkbox">
        <input type="checkbox" id="campos-adicionales" name="campos-adicionales" [checked]="esProductoManual()"
          (change)="esProductoManual.set($any($event.target).checked)" class="global-checkbox__input" />
        <label for="campos-adicionales" class="global-checkbox__contenido">
          <p class="global-checkbox__titulo">Producto Manual</p>
          <p class="global-checkbox__descripcion">Si está marcado, este producto será procesado manualmente y
            podrás agregar campos adicionales.</p>
        </label>
      </div>

      @if (esProductoManual() && camposAdicionales().length > 0) {
      <div class="formulario-campos-adicionales">
        @for (campo of camposAdicionales(); track campo.id; let i = $index) {
        <div class="campo-adicional-agregado" [class.campo-adicional-agregado--arrastrando]="estaArrastrando(campo.id)"
          [class.campo-adicional-agregado--zona-soltar]="tipoArrastrando() === 'campo' && elementoArrastrando() !== campo.id"
          draggable="true" (dragstart)="iniciarArrastreCampo($event, campo.id, i)"
          (dragover)="permitirSoltarCampo($event)" (drop)="soltarCampo($event, i)" (dragend)="limpiarArrastre()">
          <div class="campo-adicional-agregado__arrastrar">
            <img src="/iconos/ico-expandir-todo.svg" alt="Mover" class="icono-boton-mediano icono-color-secundario">
          </div>
          <div class="campo-adicional-agregado__info">
            <p class="campo-adicional-agregado__etiqueta">{{ campo.etiqueta }}</p>
            <label class="campo-adicional-agregado__identificador">ID: {{ campo.identificador }}</label>
          </div>
          <div class="campo-adicional-agregado__estados">
            <span class="campo-adicional-agregado__badge"
              [class.campo-adicional-agregado__badge--numero]="campo.tipo === 'numero'">
              {{ campo.tipo === 'numero' ? 'Número' : 'Texto' }}
            </span>
            @if (campo.requerido) {
            <span class="campo-adicional-agregado__badge campo-adicional-agregado__badge--requerido">
              Requerido
            </span>
            }
          </div>
          <div class="campo-adicional-agregado__acciones">
            <button type="button" class="campo-adicional-agregado__boton" (click)="abrirModalEditarCampo(campo)"
              aria-label="Editar campo">
              <img src="/iconos/ico-editar.svg" alt="Editar" class="icono-boton-mediano icono-color-secundario">
            </button>
            <button type="button" class="campo-adicional-agregado__boton" (click)="eliminarCampoAdicional(campo.id)"
              aria-label="Eliminar campo">
              <img src="/iconos/ico-delete.svg" alt="Eliminar" class="icono-boton-mediano icono-color-secundario">
            </button>
          </div>
        </div>
        }
      </div>
      }
    </section>

    <!-- Sección: Gestión de Precios -->
    <section class="seccion-base">
      <div class="titulo-contenedor">
        <h3>Gestión de Precios</h3>
        <button type="button" class="boton-primario" (click)="abrirModalAgregarPrecio()">
          <p>Importar Precios</p>
        </button>
        <button type="button" class="boton-primario" (click)="abrirModalAgregarPrecio()">
          <p>Agregar precio</p>
        </button>
      </div>

      @if (precios().length > 0) {
      <div class="formulario-precios">
        @for (precio of precios(); track precio.id; let i = $index) {
        <div class="precio-agregado" [class.precio-agregado--arrastrando]="estaArrastrandoPrecio(precio.id)"
          [class.precio-agregado--zona-soltar]="tipoArrastrando() === 'precio' && elementoArrastrando() !== precio.id"
          draggable="true" (dragstart)="iniciarArrastrePrecio($event, precio.id, i)"
          (dragover)="permitirSoltarPrecio($event)" (drop)="soltarPrecio($event, i)" (dragend)="limpiarArrastre()">
          <div class="precio-agregado__info">
            <div class="precio-agregado__cabecera">
              <div class="precio-agregado__cabecera-principal">
                <img src="/iconos/icon-opciones.svg" alt="Icono precio"
                  class="icono-boton-mediano icono-color-secundario">
                <p class="precio-agregado__nombre">{{ precio.nombre }}</p>
                <div class="precio-agregado__estados">
                  <span class="precio-agregado__badge"
                    [class.precio-agregado__badge--activo]="precio.estado === 'activo'"
                    [class.precio-agregado__badge--inactivo]="precio.estado === 'inactivo'"
                    [class.precio-agregado__badge--agotado]="precio.estado === 'agotado'">
                    {{ precio.estado === 'activo' ? 'Activo' : precio.estado === 'inactivo' ? 'Inactivo' : 'Agotado' }}
                  </span>
                </div>
              </div>
            </div>
            <div class="precio-agregado__detalles">
              <div class="precio-agregado__detalle-item">
                <span class="precio-agregado__detalle-etiqueta">Costo</span>
                <span class="precio-agregado__detalle-valor">${{ precio.costoCompra | number:'1.2-2' }}</span>
              </div>
              <div class="precio-agregado__detalle-item">
                <span class="precio-agregado__detalle-etiqueta">Descuento</span>
                <span class="precio-agregado__detalle-valor">{{ precio.porcentajeDescuento }}%</span>
              </div>
              <div class="precio-agregado__detalle-item">
                <span class="precio-agregado__detalle-etiqueta">Margen</span>
                <span class="precio-agregado__detalle-valor">{{ precio.margenFinalCliente }}%</span>
              </div>
              <div class="precio-agregado__detalle-item precio-agregado__detalle-item--destacado">
                <span class="precio-agregado__detalle-etiqueta">Precio</span>
                <span class="precio-agregado__detalle-valor">${{ precio.precioFinal | number:'1.2-2' }}</span>
              </div>
            </div>

          </div>
          <div class="precio-agregado__acciones">
            <button type="button" class="precio-agregado__boton" (click)="abrirModalEditarPrecio(precio)"
              aria-label="Editar precio">
              <img src="/iconos/ico-editar.svg" alt="Editar" class="icono-boton-mediano icono-color-secundario">
            </button>
            <button type="button" class="precio-agregado__boton" (click)="eliminarPrecio(precio.id)"
              aria-label="Eliminar precio">
              <img src="/iconos/ico-delete.svg" alt="Eliminar" class="icono-boton-mediano icono-color-secundario">
            </button>
          </div>
        </div>
        }
      </div>
      } @else {
      <div class="global-mensaje-vacio">
        <div class="global-mensaje-vacio__icono">
          <img src="/iconos/ico-informacion.svg" alt="Icono información"
            class="icono-boton-grande icono-color-secundario">
        </div>
        <div class="global-mensaje-vacio__contenido">
          <h4 class="global-mensaje-vacio__titulo">Nota importante</h4>
          <p class="global-mensaje-vacio__texto">
            Si el producto fue importado de otro sistema, ten en cuenta las siguientes consideraciones:
          </p>
          <ul class="global-mensaje-vacio__lista">
            <li class="global-mensaje-vacio__item">
              <span class="global-mensaje-vacio__item-bullet"></span>
              <p class="global-mensaje-vacio__item-texto">Los productos pueden tener múltiples precios (regular,
                promocional, etc.)</p>
            </li>
            <li class="global-mensaje-vacio__item">
              <span class="global-mensaje-vacio__item-bullet"></span>
              <p class="global-mensaje-vacio__item-texto">Cualquier precio con descuento será considerado
                automáticamente
                como oferta</p>
            </li>
            <li class="global-mensaje-vacio__item">
              <span class="global-mensaje-vacio__item-bullet"></span>
              <p class="global-mensaje-vacio__item-texto">Los precios con descuento aparecerán en la sección de ofertas
                de
                la tienda</p>
            </li>
            <li class="global-mensaje-vacio__item">
              <span class="global-mensaje-vacio__item-bullet"></span>
              <p class="global-mensaje-vacio__item-texto">Un producto puede tener varias ofertas activas al mismo
                tiempo</p>
            </li>
            <li class="global-mensaje-vacio__item">
              <span class="global-mensaje-vacio__item-bullet"></span>
              <p class="global-mensaje-vacio__item-texto">Los precios inactivos no serán visibles para los clientes en
                la
                tienda</p>
            </li>
            <li class="global-mensaje-vacio__item">
              <span class="global-mensaje-vacio__item-bullet"></span>
              <p class="global-mensaje-vacio__item-texto">Puedes reorganizar el orden de los precios arrastrándolos y
                soltándolos</p>
            </li>
          </ul>
        </div>
      </div>
      }
    </section>
  </div>
  <div class="contenedor-base">
    <br>

    <section class="seccion-base">
      <div class="global-checkbox">
        <input type="checkbox" name="campos-adicionales" class="global-checkbox__input" />
        <label for="campos-adicionales" class="global-checkbox__contenido">
          <p class="global-checkbox__titulo">Sincronizacion Automatica</p>
          <p class="global-checkbox__descripcion">Los cambios manuales (incluyendo titulo y slug) pueden
            ser sobreescritos por la sincronizacion automatica. Desactivarla si deseas mantener los cambios manuales.
          </p>
        </label>
      </div>
    </section>


    <!-- Sección: Contenido -->
    <section class="seccion-base">
      <div class="titulo-contenedor">
        <h3>Contenido</h3>
      </div>
      <div class="global-formulario-campo">
        <label class="global-formulario-campo__etiqueta">Descripción</label>
        <div class="global-formulario-campo__contenedor global-formulario-campo__contenedor--textarea">
          <textarea class="global-formulario-campo__textarea"
            placeholder="Ingrese la descripción del producto. Puedes agregar enlaces usando formato: [texto](url)"
            [value]="descripcion()" (input)="descripcion.set($any($event.target).value)" rows="4"></textarea>
        </div>
        <label class="global-formulario-campo__ayuda">Puedes agregar enlaces usando el formato: [texto del
          enlace](https://ejemplo.com)</label>
      </div>
      <div class="global-formulario-campo">
        <label class="global-formulario-campo__etiqueta">Instrucciones</label>
        <div class="global-formulario-campo__contenedor global-formulario-campo__contenedor--textarea">
          <textarea class="global-formulario-campo__textarea"
            placeholder="Ingrese las instrucciones de uso. Puedes agregar enlaces usando formato: [texto](url)"
            [value]="instrucciones()" (input)="instrucciones.set($any($event.target).value)" rows="4"></textarea>
        </div>
        <label class="global-formulario-campo__ayuda">Puedes agregar enlaces usando el formato: [texto del
          enlace](https://ejemplo.com)</label>
      </div>
      <div class="global-formulario-campo">
        <label class="global-formulario-campo__etiqueta">Términos y Condiciones</label>
        <div class="global-formulario-campo__contenedor global-formulario-campo__contenedor--textarea">
          <textarea class="global-formulario-campo__textarea"
            placeholder="Ingrese los términos y condiciones. Puedes agregar enlaces usando formato: [texto](url)"
            [value]="terminos()" (input)="terminos.set($any($event.target).value)" rows="4"></textarea>
        </div>
        <label class="global-formulario-campo__ayuda">Puedes agregar enlaces usando el formato: [texto del
          enlace](https://ejemplo.com)</label>
      </div>
    </section>
  </div>
</div>


<!-- Modal: Tipo de Campo -->
<app-modal [estaAbierto]="modalTipoCampoAbierto()" (cerrar)="cerrarModalTipoCampo()">
  <div class="global-modal">
    <div class="global-modal__cabecera">
      <h3 class="global-modal__titulo">{{ campoAdicionalEditando() ? 'Editar Campo' : 'Agregar Campo' }}</h3>
      <button type="button" class="global-modal__boton-cerrar" (click)="cerrarModalTipoCampo()"
        aria-label="Cerrar modal">
        <img src="/iconos/ico-cerrar.svg" alt="Cerrar" class="icono-boton icono-color-secundario">
      </button>
    </div>
    <div class="global-modal__contenido">
      <div class="global-formulario-campo">
        <label class="global-formulario-campo__etiqueta">Etiqueta del Campo</label>
        <div class="global-formulario-campo__contenedor">
          <input type="text" class="global-formulario-campo__input" placeholder="Ej: ID del jugador"
            [value]="etiquetaCampo()" (input)="etiquetaCampo.set($any($event.target).value)">
        </div>
        <label class="global-formulario-campo__ayuda">
          Se generará automáticamente el identificador. Ej: id_del_jugador
        </label>
      </div>

      <div class="global-formulario-campo">
        <label class="global-formulario-campo__etiqueta">Tipo de Campo</label>
        <div class="global-formulario-opciones-radio">
          <label class="global-formulario-opciones-radio__opcion">
            <input type="radio" name="tipo-campo" value="texto" [checked]="tipoCampoSeleccionado() === 'texto'"
              (change)="tipoCampoSeleccionado.set('texto')" class="global-radio__input">
            <span class="global-formulario-opciones-radio__label">Texto</span>
          </label>
          <label class="global-formulario-opciones-radio__opcion">
            <input type="radio" name="tipo-campo" value="numero" [checked]="tipoCampoSeleccionado() === 'numero'"
              (change)="tipoCampoSeleccionado.set('numero')" class="global-radio__input">
            <span class="global-formulario-opciones-radio__label">Número</span>
          </label>
        </div>
      </div>

      <div class="global-checkbox">
        <input type="checkbox" id="campo-requerido-modal" name="campo-requerido-modal" [checked]="campoRequerido()"
          (change)="campoRequerido.set($any($event.target).checked)" class="global-checkbox__input" />
        <label for="campo-requerido-modal" class="global-checkbox__contenido">
          <p class="global-checkbox__titulo">Campo requerido</p>
        </label>
      </div>
    </div>
    <div class="global-modal__acciones">
      <button type="button" class="boton-secundario" (click)="cerrarModalTipoCampo()">
        <p>Cancelar</p>
      </button>
      <button type="button" class="boton-primario" (click)="guardarCampoAdicional()">
        <p>{{ campoAdicionalEditando() ? 'Guardar Cambios' : 'Agregar' }}</p>
      </button>
    </div>
  </div>
</app-modal>

<!-- Modal: Precio -->
<app-modal [estaAbierto]="modalPrecioAbierto()" (cerrar)="cerrarModalPrecio()">
  <div class="global-modal global-modal--ancho">
    <div class="global-modal__cabecera">
      <h3 class="global-modal__titulo">{{ precioEditando() ? 'Editar Precio' : 'Agregar Precio' }}</h3>
      <button type="button" class="global-modal__boton-cerrar" (click)="cerrarModalPrecio()" aria-label="Cerrar modal">
        <img src="/iconos/ico-cerrar.svg" alt="Cerrar" class="icono-boton icono-color-secundario">
      </button>
    </div>
    <div class="global-modal__contenido global-modal__contenido--grid">
      <div class="global-formulario-campo">
        <label class="global-formulario-campo__etiqueta">Nombre</label>
        <div class="global-formulario-campo__contenedor">
          <input type="text" class="global-formulario-campo__input" placeholder="Ej: Precio estándar"
            [value]="nombrePrecio()" (input)="nombrePrecio.set($any($event.target).value)">
        </div>
      </div>

      <div class="global-formulario-campo">
        <label class="global-formulario-campo__etiqueta">Costo de compra</label>
        <div class="global-formulario-campo__contenedor">
          <input type="number" class="global-formulario-campo__input" placeholder="0.00" step="0.01" min="0"
            [value]="costoCompra()" (input)="costoCompra.set($any($event.target).valueAsNumber || 0)">
        </div>
      </div>

      <div class="global-formulario-campo">
        <label class="global-formulario-campo__etiqueta">Porcentaje de descuento (%)</label>
        <div class="global-formulario-campo__contenedor">
          <input type="number" class="global-formulario-campo__input" placeholder="0" step="0.01" min="0" max="100"
            [value]="porcentajeDescuento()" (input)="porcentajeDescuento.set($any($event.target).valueAsNumber || 0)">
        </div>
      </div>

      <div class="global-formulario-campo">
        <label class="global-formulario-campo__etiqueta">Margen final del cliente (%)</label>
        <div class="global-formulario-campo__contenedor">
          <input type="number" class="global-formulario-campo__input" placeholder="0" step="0.01" min="0"
            [value]="margenFinalCliente()" (input)="margenFinalCliente.set($any($event.target).valueAsNumber || 0)">
        </div>
        <label class="global-formulario-campo__ayuda">
          Porcentaje de margen que se aplicará sobre el costo de compra
        </label>
      </div>

      <div class="global-formulario-campo">
        <label class="global-formulario-campo__etiqueta">Precio final</label>
        <div class="global-formulario-campo__contenedor">
          <input type="text" class="global-formulario-campo__inputformulario-campo__input--readonly"
            [value]="precioFinalCalculado() | number:'1.2-2'" readonly>
        </div>
        <label class="global-formulario-campo__ayuda">
          Se calcula automáticamente: Costo de compra × (1 + Margen final del cliente (%))
        </label>
      </div>

      <div class="global-formulario-campo">
        <label class="global-formulario-campo__etiqueta">Estado</label>
        <div class="global-formulario-opciones-radio">
          <label class="global-formulario-opciones-radio__opcion">
            <input type="radio" name="estado-precio" value="activo" [checked]="estadoPrecio() === 'activo'"
              (change)="estadoPrecio.set('activo')" class="global-radio__input">
            <span class="global-formulario-opciones-radio__label">Activo</span>
          </label>
          <label class="global-formulario-opciones-radio__opcion">
            <input type="radio" name="estado-precio" value="inactivo" [checked]="estadoPrecio() === 'inactivo'"
              (change)="estadoPrecio.set('inactivo')" class="global-radio__input">
            <span class="global-formulario-opciones-radio__label">Inactivo</span>
          </label>
          <label class="global-formulario-opciones-radio__opcion">
            <input type="radio" name="estado-precio" value="agotado" [checked]="estadoPrecio() === 'agotado'"
              (change)="estadoPrecio.set('agotado')" class="global-radio__input">
            <span class="global-formulario-opciones-radio__label">Agotado</span>
          </label>
        </div>
      </div>
    </div>
    <div class="global-modal__acciones">
      <button type="button" class="boton-secundario" (click)="cerrarModalPrecio()">
        <p>Cancelar</p>
      </button>
      <button type="button" class="boton-primario" (click)="guardarPrecio()">
        <p>{{ precioEditando() ? 'Guardar Cambios' : 'Agregar' }}</p>
      </button>
    </div>
  </div>
</app-modal>
