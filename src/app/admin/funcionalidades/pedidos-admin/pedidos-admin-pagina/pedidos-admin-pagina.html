<div class="contenedor-base" (click)="cerrarTodosLosDropdowns()">
  <!-- ===== SECCIÓN: TITULO Y OPCIONES ===== -->
  <section class="titulo-opciones-contenedor">
    <div class="titulo-contenedor">
      <img src="/iconos/ico-orden.svg" alt="Icono pedidos" class="icono-boton icono-color-base">
      <h3>Pedidos</h3>
    </div>
    <div class="opciones-contenedor">
      <button class="boton-secundario" (click)="alternarFiltros()">
        <p>{{ filtrosVisibles() ? 'Ocultar Filtros' : 'Mostrar Filtros' }}</p>
      </button>
    </div>
  </section>

  <!-- Filtro por estado (badges) -->
  <section class="pedidos-admin-badges">
    @for (item of estadosFiltro; track item.valor) {
    <button type="button" class="global-badge pedidos-admin-badge"
      [class.pedidos-admin-badge--activo]="estadoActivoFiltro() === item.valor"
      (click)="filtrarPorEstado(item.valor)">
      {{ item.nombre }} ({{ contadorPorEstado(item.valor) }})
    </button>
    }
  </section>

  <!-- ===== SECCIÓN: FILTROS AVANZADOS ===== -->
  @if (filtrosVisibles()) {
  <section class="global-filtros" (click)="$event.stopPropagation()">
    <!-- Buscador - Por ID, usuario o producto -->
    <div class="global-filtros__item">
      <p class="global-filtros__titulo">Buscador</p>
      <div class="global-filtros__busqueda">
        <img src="/iconos/ico-busqueda.svg" alt="Icono busqueda" class="icono-boton icono-color-base">
        <input type="text" placeholder="Buscar por número de pedido..." class="global-filtros__input"
          [value]="textoBusqueda()" (input)="textoBusqueda.set($any($event.target).value)">
      </div>
    </div>

    <!-- Fecha de compra -->
    <div class="global-filtros__item">
      <p class="global-filtros__titulo">Fecha de compra</p>
      <div class="global-filtros__busqueda" (click)="$event.stopPropagation()">
        <input type="date" class="global-filtros__input" [value]="fechaCompra()"
          (change)="fechaCompra.set($any($event.target).value)" (click)="$event.stopPropagation()">
      </div>
    </div>

    <!-- Botón Limpiar -->
    <div class="global-filtros__item">
      <button class="boton-secundario global-filtros__boton-icono" (click)="limpiarFiltros()" type="button">
        <img src="/iconos/ico-limpiar.svg" alt="Icono limpiar" class="icono-boton icono-color-base">
      </button>
    </div>
  </section>
  }

  <!-- ===== SECCIÓN: TABLA DE PEDIDOS ===== -->
  <section class="global-tabla">
    @if (estaCargando()) {
    <app-bloque-estado-tabla estado="cargando" mensajeCarga="Cargando pedidos..." />
    } @else if (pedidosPaginados().length === 0) {
    <app-bloque-estado-tabla estado="vacio" tituloVacio="No se encontraron pedidos"
      textoVacio="No hay pedidos o los filtros no coinciden con ningún resultado." iconoVacio="/iconos/ico-orden.svg" />
    } @else {
    <table class="global-tabla__elemento">
      <thead class="global-tabla__cabecera">
        <tr>
          <th>Número de pedido</th>
          <th>Cantidad productos</th>
          <th>Total $</th>
          <th>Fecha</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody class="global-tabla__cuerpo">
        @for (pedido of pedidosPaginados(); track pedido.id_pedido) {
        <tr class="global-tabla__fila">
          <td class="global-tabla__celda">{{ pedido.numero_pedido }}</td>
          <td class="global-tabla__celda">{{ cantidadTotalProductos(pedido) }}</td>
          <td class="global-tabla__celda">${{ pedido.total }}</td>
          <td class="global-tabla__celda">{{ pedido.fecha | date:'short' }}</td>
          <td class="global-tabla__celda">
            <span class="global-badge global-badge--{{pedido.estado}}">
              {{ pedido.estado }}
            </span>
          </td>
          <td class="global-tabla__celda global-tabla__celda-acciones">
            <button type="button" (click)="verDetalles(pedido)" title="Ver más"
              class="boton-secundario global-tabla__boton-accion">
              <img src="/iconos/ico-ojo-abierto.svg" alt="" class="icono-boton icono-color-base">
              <p>Ver más</p>
            </button>
          </td>
        </tr>
        }
      </tbody>
    </table>
    <!-- ===== SECCIÓN: PAGINACIÓN ===== -->
    <div class="global-paginacion">
      <div class="global-paginacion__controles">
        <button class="global-paginacion__boton global-paginacion__boton--anterior" (click)="paginaAnterior()"
          [disabled]="paginaActual() === 1">
          <img src="/iconos/ico-flecha-izquierda-tabla.svg" alt="Icono flecha izquierda"
            class="icono-boton icono-color-base">
        </button>
        <div class="global-paginacion__numeros">
          @for (pagina of paginasAMostrar(); track pagina) {
          @if (pagina === -1) {
          <span class="global-paginacion__separador">...</span>
          } @else {
          <button class="global-paginacion__numero"
            [class.global-paginacion__numero--activa]="pagina === paginaActual()" (click)="irAPagina(pagina)"
            type="button">
            {{ pagina }}
          </button>
          }
          }
        </div>
        <button class="global-paginacion__boton global-paginacion__boton--siguiente" (click)="paginaSiguiente()"
          [disabled]="paginaActual() === totalPaginas()">
          <img src="/iconos/ico-flecha-derecha-tabla.svg" alt="Icono flecha derecha"
            class="icono-boton icono-color-base">
        </button>
      </div>
      <p class="global-paginacion__info">
        {{ (paginaActual() - 1) * pedidosPorPagina() + 1 }}-{{ Math.min(paginaActual() * pedidosPorPagina(),
        totalPedidos()) }} de {{ totalPedidos() }}
      </p>
    </div>
    }
  </section>
</div>

<!-- ===== MODAL: DETALLES DEL PEDIDO ===== -->
<app-modal [estaAbierto]="modalDetallesAbierto()" (cerrar)="cerrarModalDetalles()">
  @if (pedidoSeleccionado()) {
  <div class="global-modal global-modal--ancho detalle-pedido-modal">
    <!-- Cabecera -->
    <div class="global-modal__cabecera">
      <h3 class="global-modal__titulo">Detalle completo</h3>
      <button type="button" class="global-modal__boton-cerrar" (click)="cerrarModalDetalles()"
        aria-label="Cerrar modal">
        <img src="/iconos/ico-cerrar.svg" alt="Cerrar" class="icono-boton icono-color-secundario">
      </button>
    </div>

    <!-- Contenido -->
    <div class="global-modal__contenido detalle-pedido__contenido">
      <!-- Información del pedido -->
      <div class="detalle-pedido__seccion">
        <h4 class="detalle-pedido__titulo">Información del Pedido</h4>
        <div class="detalle-pedido__grid">
          <div>
            <p class="detalle-pedido__etiqueta">Número de pedido</p>
            <p class="detalle-pedido__valor">{{ pedidoSeleccionado()!.numero_pedido }}</p>
          </div>
          <div>
            <p class="detalle-pedido__etiqueta">Fecha</p>
            <p class="detalle-pedido__valor">{{ pedidoSeleccionado()!.fecha | date:'short' }}</p>
          </div>
          <div>
            <p class="detalle-pedido__etiqueta">Estado</p>
            <span class="global-badge global-badge--{{ pedidoSeleccionado()!.estado }}">
              {{ pedidoSeleccionado()!.estado }}
            </span>
          </div>
        </div>
      </div>

      <!-- Productos / Líneas del pedido -->
      @if (pedidoSeleccionado()!.detalles && pedidoSeleccionado()!.detalles!.length > 0) {
      <div class="detalle-pedido__seccion">
        <h4 class="detalle-pedido__titulo">Productos del pedido</h4>
        <div class="detalle-pedido__productos-lista">
          @for (detalle of pedidoSeleccionado()!.detalles; track detalle.id_detalle) {
          <article class="detalle-pedido__producto-tarjeta">
            <div class="detalle-pedido__producto-cabecera">
              <div class="detalle-pedido__producto-nombres">
                <span class="detalle-pedido__producto-nombre">{{ detalle.nombreProducto ?? 'ID Precio: ' + detalle.id_precio }}</span>
                @if (detalle.nombrePrecio && detalle.nombrePrecio !== detalle.nombreProducto) {
                <span class="detalle-pedido__producto-precio-nombre">{{ detalle.nombrePrecio }}</span>
                }
              </div>
              <span class="detalle-pedido__producto-subtotal">${{ detalle.subtotal }}</span>
            </div>
            <div class="detalle-pedido__producto-meta">
              <span class="detalle-pedido__producto-meta-item">
                <strong>Cantidad:</strong> {{ detalle.cantidad }}
              </span>
              @if (detalle.estado_entrega) {
              <span class="detalle-pedido__producto-meta-item">
                <strong>Entrega:</strong>
                <span class="global-badge global-badge--{{ detalle.estado_entrega }}">{{ detalle.estado_entrega }}</span>
              </span>
              }
            </div>
            @if (tieneCamposDinamicos(detalle)) {
            <div class="detalle-pedido__producto-campos">
              @for (item of camposDinamicosParaMostrar(detalle); track item.etiqueta) {
              <span class="detalle-pedido__producto-campo">{{ item.etiqueta }}: {{ item.valor }}</span>
              }
            </div>
            }
            @if ((detalle.puede_actualizar ?? false) || (detalle.puede_reembolsar ?? false)) {
            <div class="detalle-pedido__producto-acciones">
              @if (detalle.puede_actualizar) {
              <button type="button" (click)="completarDetalle(pedidoSeleccionado()!, detalle)" title="Marcar como completado"
                [disabled]="detalleProcesandoId() === detalle.id_detalle"
                class="boton-secundario detalle-pedido__boton-accion">
                {{ detalleProcesandoId() === detalle.id_detalle ? 'Procesando...' : 'Completar' }}
              </button>
              }
              @if (detalle.puede_reembolsar) {
              <button type="button" (click)="reembolsarDetalle(pedidoSeleccionado()!, detalle)" title="Reembolsar este ítem"
                [disabled]="detalleProcesandoId() === detalle.id_detalle"
                class="boton-secundario detalle-pedido__boton-accion">
                Reembolsar
              </button>
              }
            </div>
            }
          </article>
          }
        </div>
      </div>
      }

      <!-- Información de Pago -->
      <div class="detalle-pedido__seccion">
        <h4 class="detalle-pedido__titulo">Información de Pago</h4>
        <div class="detalle-pedido__grid detalle-pedido__grid--dos-columnas">
          <div>
            <p class="detalle-pedido__etiqueta">Método de pago</p>
            <p class="detalle-pedido__valor">{{ pedidoSeleccionado()!.id_metodo_pago ?? '—' }}</p>
          </div>
          @if (pedidoSeleccionado()!.fecha_pago) {
          <div>
            <p class="detalle-pedido__etiqueta">Fecha de pago</p>
            <p class="detalle-pedido__valor">{{ pedidoSeleccionado()!.fecha_pago | date:'short' }}</p>
          </div>
          }
        </div>
      </div>

      <!-- Resumen Financiero -->
      <div class="detalle-pedido__resumen">
        <h4 class="detalle-pedido__resumen-titulo">Resumen Financiero</h4>
        <div class="detalle-pedido__resumen-lista">
          <div class="detalle-pedido__resumen-fila">
            <span class="detalle-pedido__resumen-etiqueta">Subtotal</span>
            <span class="detalle-pedido__resumen-valor">${{ pedidoSeleccionado()!.subtotal }}</span>
          </div>
          @if (pedidoSeleccionado()!.descuento > 0) {
          <div class="detalle-pedido__resumen-fila detalle-pedido__resumen-fila--descuento">
            <span class="detalle-pedido__resumen-etiqueta">Descuento</span>
            <span class="detalle-pedido__resumen-valor">-${{ pedidoSeleccionado()!.descuento }}</span>
          </div>
          }
          <div class="detalle-pedido__resumen-fila detalle-pedido__resumen-fila--total">
            <span class="detalle-pedido__resumen-etiqueta">Total</span>
            <span class="detalle-pedido__resumen-valor detalle-pedido__resumen-valor--total">${{ pedidoSeleccionado()!.total }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  }
</app-modal>